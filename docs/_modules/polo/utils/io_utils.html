

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>polo.utils.io_utils &mdash; Polo 0.0.5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Polo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html#os-specific-installation-notes">OS Specific Installation Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html#issues-others-have-encountered">Issues Others have Encountered</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html#running-from-source">Running From Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQS.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide.html">Userâ€™s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../video_guides.html">Video Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../beta_testers.html">Beta Testers Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../polo.html">Polo Code Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Polo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../polo.html">polo</a> &raquo;</li>
        
      <li>polo.utils.io_utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for polo.utils.io_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

<span class="kn">from</span> <span class="nn">pptx</span> <span class="kn">import</span> <span class="n">Presentation</span>
<span class="kn">from</span> <span class="nn">pptx.util</span> <span class="kn">import</span> <span class="n">Inches</span><span class="p">,</span> <span class="n">Pt</span>

<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">QtWidgets</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QBrush</span><span class="p">,</span> <span class="n">QColor</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">,</span> <span class="n">QPixmap</span><span class="p">,</span> <span class="n">QImage</span><span class="p">,</span> <span class="n">QPainter</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QAction</span><span class="p">,</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QGridLayout</span>

<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">polo</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">polo</span> <span class="kn">import</span> <span class="n">polo_version</span>
<span class="kn">from</span> <span class="nn">polo.threads.thread</span> <span class="kn">import</span> <span class="n">QuickThread</span>
<span class="kn">from</span> <span class="nn">polo.utils.exceptions</span> <span class="kn">import</span> <span class="n">EmptyRunNameError</span><span class="p">,</span> <span class="n">ForbiddenImageTypeError</span>
<span class="kn">from</span> <span class="nn">polo.crystallography.cocktail</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">polo.utils.dialog_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">polo.utils.unrar_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">polo.utils.math_utils</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">make_default_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="RunImporter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter">[docs]</a><span class="k">class</span> <span class="nc">RunImporter</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Class to hold general use methods for importing runs into Polo.</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="RunImporter.directory_validator"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter.directory_validator">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">directory_validator</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check if a directory should proceed further down the import</span>
<span class="sd">        pipeline. Includes checks to make sure the directory exists,</span>
<span class="sd">        is a directory and that the directory contains images of</span>
<span class="sd">        filetypes that can be imported.</span>

<span class="sd">        :param dir_path: Path to a directory</span>
<span class="sd">        :type dir_path: str or Path</span>
<span class="sd">        :return: True, if directory can be imported, an Exception otherwise</span>
<span class="sd">        :rtype: bool or Exception</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
                <span class="n">files</span> <span class="o">=</span> <span class="n">list_dir_abs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">ForbiddenImageTypeError</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory validation failed with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="ne">NotADirectoryError</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory validation failed with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="ne">FileNotFoundError</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory validation failed with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="ne">FileNotFoundError</span></div>
    
<div class="viewcode-block" id="RunImporter.parse_hwi_dir_metadata"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter.parse_hwi_dir_metadata">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_hwi_dir_metadata</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Parse the directory name of an :class:`HWIRun` directory to pull out</span>
<span class="sd">        metadata. If the directory name conforms to HWI naming conventions</span>
<span class="sd">        the function should be able to return the image spectrum, the plate id,</span>
<span class="sd">        the date and the run name. If the directory does not conform to HWI</span>
<span class="sd">        naming standards this will cause an exception which is caught and the</span>
<span class="sd">        function will return None.</span>

<span class="sd">        If the parse is successful will return a dictionary with the following</span>
<span class="sd">        format.</span>

<span class="sd">         .. code-block:: text</span>

<span class="sd">            {&#39;image_spectrum&#39;: String describing the image spectrum,</span>
<span class="sd">            &#39;plate_id&#39;: String representing the plate id,</span>
<span class="sd">            &#39;date&#39;: Datetime instance of imaging date,</span>
<span class="sd">            &#39;run_name&#39;: String holding the run name</span>
<span class="sd">            }</span>

<span class="sd">        :param dir_name: Name of directory to check for metadata</span>
<span class="sd">        :type dir_name: str or Path</span>
<span class="sd">        :return: Dictionary of extracted metadata or None if parse fails</span>
<span class="sd">        :rtype: dict or None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dir_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">image_type</span> <span class="o">=</span> <span class="n">dir_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">image_type</span> <span class="ow">in</span> <span class="n">SPEC_KEYS</span><span class="p">:</span>
                <span class="n">image_spectrum</span> <span class="o">=</span> <span class="n">SPEC_KEYS</span><span class="p">[</span><span class="n">image_type</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image_spectrum</span> <span class="o">=</span> <span class="n">IMAGE_SPECS</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># default to visible</span>
            <span class="n">plate_id</span> <span class="o">=</span> <span class="n">dir_name</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dir_name</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="s1">&#39;%Y&#39;&#39;%m&#39;&#39;</span><span class="si">%d</span><span class="s1">&#39;&#39;%H&#39;&#39;%M&#39;</span><span class="p">)</span>
            
            <span class="c1">#return image_type, plate_id, date, run_name  # last is suggeseted run name</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;image_spectrum&#39;</span><span class="p">:</span> <span class="n">image_spectrum</span><span class="p">,</span>
                <span class="s1">&#39;plate_id&#39;</span><span class="p">:</span> <span class="n">plate_id</span><span class="p">,</span>
                <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
                <span class="s1">&#39;run_name&#39;</span><span class="p">:</span> <span class="n">dir_name</span>
                <span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1"> attempting to parse </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="n">RunImporter</span><span class="o">.</span><span class="n">parse_hwi_dir_metadata</span><span class="p">,</span> <span class="n">dir_name</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span></div>
    
<div class="viewcode-block" id="RunImporter.crack_open_a_rar_one"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter.crack_open_a_rar_one">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">crack_open_a_rar_one</span><span class="p">(</span><span class="n">rar_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Method to open a compressed rar archive.</span>

<span class="sd">        :param rar_path: Path to rar archive.</span>
<span class="sd">        :type rar_path: str or Path</span>
<span class="sd">        :return: Path to uncompressed archive if successful</span>
<span class="sd">        :rtype: Path</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rar_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">rar_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rar_path</span><span class="p">)</span>
        <span class="n">parent_path</span> <span class="o">=</span> <span class="n">rar_path</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">return</span> <span class="n">unrar_archive</span><span class="p">(</span><span class="n">rar_path</span><span class="p">,</span> <span class="n">parent_path</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="RunImporter.import_from_xtal_thread"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter.import_from_xtal_thread">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">import_from_xtal_thread</span><span class="p">(</span><span class="n">xtal_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Given the path to an xtal file returns a :class:`QuickThread`</span>
<span class="sd">        which can be run to load the run serialized in the</span>
<span class="sd">        xtal file.</span>

<span class="sd">        :param xtal_path: File path to xtal file.</span>
<span class="sd">        :type xtal_path: str</span>
<span class="sd">        :return: QuickThread for deserializing the given xtal file.</span>
<span class="sd">        :rtype: QuickThread</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">RunDeserializer</span><span class="p">(</span><span class="n">xtal_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">xtal_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">reader</span><span class="o">.</span><span class="n">make_read_xtal_thread</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="RunImporter.make_xtal_file_dialog"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter.make_xtal_file_dialog">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_xtal_file_dialog</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a file dialog specifically for browsing for</span>
<span class="sd">        xtal files.</span>

<span class="sd">        :param parent: Parent for the file dialog, defaults to None</span>
<span class="sd">        :type parent: QDialog, optional</span>
<span class="sd">        :return: QFileDialog</span>
<span class="sd">        :rtype: QFileDialog</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">file_dlg</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">file_dlg</span><span class="o">.</span><span class="n">setFileMode</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QFileDialog</span><span class="o">.</span><span class="n">ExistingFiles</span><span class="p">)</span>
        <span class="n">file_dlg</span><span class="o">.</span><span class="n">setNameFilter</span><span class="p">(</span><span class="s1">&#39;xtal or xtals (*.xtal *.xtals)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">file_dlg</span></div>
    
<div class="viewcode-block" id="RunImporter.unpack_rar_archive_thread"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter.unpack_rar_archive_thread">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">unpack_rar_archive_thread</span><span class="p">(</span><span class="n">archive_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a :class:`QuickThread` that is setup to de-compress</span>
<span class="sd">        a rar archive file.</span>

<span class="sd">        :param archive_path: Path to rar archive.</span>
<span class="sd">        :type archive_path: str or Path</span>
<span class="sd">        :return: QuickThread that can be run to de-compress the given archive path.</span>
<span class="sd">        :rtype: QuickThread</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">archive_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;.rar&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">QuickThread</span><span class="p">(</span><span class="n">job_func</span><span class="o">=</span><span class="n">RunImporter</span><span class="o">.</span><span class="n">crack_open_a_rar_one</span><span class="p">,</span> <span class="n">rar_path</span><span class="o">=</span><span class="n">archive_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunImporter.import_run_from_directory"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter.import_run_from_directory">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">import_run_from_directory</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Imports a run from a local directory. First attempts to import</span>
<span class="sd">        the run as an :class:`HWIRun` and if this fails attempts an import as</span>
<span class="sd">        a general :class:`Run` object.</span>

<span class="sd">        :param data_dir: Directory to build the Run from</span>
<span class="sd">        :type data_dir: str or Path</span>
<span class="sd">        :return: Run, HWIRun or False depending on directory content</span>
<span class="sd">                 and if import succeeds.</span>
<span class="sd">        :rtype: Run, HWIRun, bool</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">hwi_import_attempt</span> <span class="o">=</span> <span class="n">RunImporter</span><span class="o">.</span><span class="n">import_hwi_run</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hwi_import_attempt</span><span class="p">,</span> <span class="n">HWIRun</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">hwi_import_attempt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RunImporter</span><span class="o">.</span><span class="n">import_general_run</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunImporter.import_hwi_run"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter.import_hwi_run">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">import_hwi_run</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Attempt to create a :class:`HWIRun` from a directory of</span>
<span class="sd">        images.</span>

<span class="sd">        :param data_dir: Directory to import from.</span>
<span class="sd">        :type data_dir: str or Path</span>
<span class="sd">        :return: HWIRun if import is successful, False otherwise</span>
<span class="sd">        :rtype: HWIRun, bool</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">RunImporter</span><span class="o">.</span><span class="n">directory_validator</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">polo</span> <span class="kn">import</span> <span class="n">tim</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">XmlReader</span><span class="p">()</span><span class="o">.</span><span class="n">find_and_read_plate_data</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
            <span class="n">file_name_data</span> <span class="o">=</span> <span class="n">RunImporter</span><span class="o">.</span><span class="n">parse_hwi_dir_metadata</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata</span> <span class="ow">and</span> <span class="n">file_name_data</span><span class="p">:</span>
                <span class="n">date</span> <span class="o">=</span> <span class="n">file_name_data</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
                <span class="n">menu</span> <span class="o">=</span> <span class="n">tim</span><span class="o">.</span><span class="n">get_menu_by_date</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">)</span>
                <span class="c1"># assuming soluble need to change based on metadata parse</span>
                <span class="n">new_run</span> <span class="o">=</span> <span class="n">HWIRun</span><span class="p">(</span><span class="n">image_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">cocktail_menu</span><span class="o">=</span><span class="n">menu</span><span class="p">,</span> <span class="o">**</span><span class="n">file_name_data</span><span class="p">)</span>
                <span class="n">new_run</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>  <span class="c1"># from xml data</span>
                <span class="n">new_run</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># for user supplied data</span>
                <span class="c1"># that could overwrite what is in metadata</span>
                <span class="n">new_run</span><span class="o">.</span><span class="n">add_images_from_dir</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">new_run</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># TODO try importing as non hwi run and show error message</span>
            
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RunImporter.import_general_run"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunImporter.import_general_run">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">import_general_run</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Attempt to import a :class:`Run` from a directory of images. </span>

<span class="sd">        :param data_dir: [description]</span>
<span class="sd">        :type data_dir: [type]</span>
<span class="sd">        :return: [description]</span>
<span class="sd">        :rtype: [type]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">RunImporter</span><span class="o">.</span><span class="n">directory_validator</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># cover all required arguments</span>
            <span class="k">if</span> <span class="s1">&#39;run_name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;run_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="s1">&#39;image_dir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;image_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dir</span>
            <span class="n">new_run</span> <span class="o">=</span> <span class="n">Run</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">new_run</span><span class="o">.</span><span class="n">add_images_from_dir</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">new_run</span>
        <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="RunSerializer"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunSerializer">[docs]</a><span class="k">class</span> <span class="nc">RunSerializer</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">run</span>

<div class="viewcode-block" id="RunSerializer.make_thread"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunSerializer.make_thread">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_thread</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">job_function</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates a new :class:`QuickThread` object. The job function is the</span>
<span class="sd">        function the thread will execute and and arguments that the job</span>
<span class="sd">        function requires should be passed has keyword arguments. These are</span>
<span class="sd">        stored as a dictionary in the new thread object until the thread is</span>
<span class="sd">        activated and they are passed as arguments.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">QuickThread</span><span class="p">(</span><span class="n">job_function</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunSerializer.path_suffix_checker"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunSerializer.path_suffix_checker">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">path_suffix_checker</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">desired_suffix</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check is a file path has a desired suffix, if not then replace the</span>
<span class="sd">        current suffix with the desired suffix. Useful for checking filenames</span>
<span class="sd">        that are taken from user input.</span>

<span class="sd">        :param desired_suffix: File extension for given file path.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">desired_suffix</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="n">desired_suffix</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">desired_suffix</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="RunSerializer.path_validator"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunSerializer.path_validator">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">path_validator</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Tests to ensure a path exists. Passing parent = True will check for</span>
<span class="sd">        the existence of the parent directory of the path.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">.unitsn&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="HtmlWriter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter">[docs]</a><span class="k">class</span> <span class="nc">HtmlWriter</span><span class="p">(</span><span class="n">RunSerializer</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HtmlWriter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="HtmlWriter.make_template"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter.make_template">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_template</span><span class="p">(</span><span class="n">template_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Given a path to an html file to serve as a jinja2 template, read the</span>
<span class="sd">        file and create a new template object.</span>

<span class="sd">        :param template_path: Path to the jinja2 template file.</span>
<span class="sd">        :type temlate_path: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">template_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">template_path</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">template</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span></div>

<div class="viewcode-block" id="HtmlWriter.write_complete_run"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter.write_complete_run">[docs]</a>    <span class="k">def</span> <span class="nf">write_complete_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">encode_images</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create an HTML report from a :class:`Run` or :class:`HWIRun`</span>
<span class="sd">        instance.</span>

<span class="sd">        :param output_path: Path to write html file to.</span>
<span class="sd">        :type output_path: str or Path</span>
<span class="sd">        :param encode_images: Write images as base64 directly to the html file,</span>
<span class="sd">                              defaults to True. Greatly increases the file size</span>
<span class="sd">                              but means that report will still contain images</span>
<span class="sd">                              even if the originals are deleted or removed.</span>
<span class="sd">        :type encode_images: bool, optional</span>
<span class="sd">        :return: Path to html report if write succeeds, Exception otherwise. </span>
<span class="sd">        :rtype: str or Exception</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">path_validator</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">:</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">encode_images</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">encode_images_to_base64</span><span class="p">()</span>
                    <span class="n">run</span> <span class="o">=</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">clean_run_for_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
                    <span class="n">images</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">XtalWriter</span><span class="o">.</span><span class="n">json_encoder</span><span class="p">))</span>
                    <span class="p">[</span><span class="n">RunDeserializer</span><span class="o">.</span><span class="n">clean_base64_string</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="s1">&#39;_bites&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

                    <span class="n">template</span> <span class="o">=</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">make_template</span><span class="p">(</span><span class="n">RUN_HTML_TEMPLATE</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">template</span><span class="p">:</span>
                        <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                            <span class="n">images</span><span class="o">=</span><span class="n">images</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run_name</span><span class="p">,</span>
                            <span class="n">annotations</span><span class="o">=</span><span class="s1">&#39;No annotations&#39;</span><span class="p">)</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">html_file</span><span class="p">:</span>
                            <span class="n">html_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
                            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_complete_run</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="HtmlWriter.write_grid_screen"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter.write_grid_screen">[docs]</a>    <span class="k">def</span> <span class="nf">write_grid_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">plate_list</span><span class="p">,</span> <span class="n">well_number</span><span class="p">,</span>
                          <span class="n">x_reagent</span><span class="p">,</span> <span class="n">y_reagent</span><span class="p">,</span> <span class="n">well_volume</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write the contents of optimization grid screen to an html file.</span>

<span class="sd">        :param output_path: Path to html file</span>
<span class="sd">        :type output_path: str</span>
<span class="sd">        :param plate_list: list containing grid screen data</span>
<span class="sd">        :type plate_list: list</span>
<span class="sd">        :param well_number: well number of hit screen is created from</span>
<span class="sd">        :type well_number: int or str</span>
<span class="sd">        :param x_reagent: reagent varied in x direction</span>
<span class="sd">        :type x_reagent: Reagent</span>
<span class="sd">        :param y_reagent: reagent varied in y direction</span>
<span class="sd">        :type y_reagent: Reagent</span>
<span class="sd">        :param well_volume: Volume of well used in screen</span>
<span class="sd">        :type well_volume: int or str</span>
<span class="sd">        :param run_name: name of run, defaults to None</span>
<span class="sd">        :type run_name: str, optional</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">path_validator</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">make_template</span><span class="p">(</span><span class="n">SCREEN_HTML_TEMPLATE</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_name</span><span class="p">:</span>
                <span class="n">run_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run_name</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">plate_list</span><span class="o">=</span><span class="n">plate_list</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">,</span>
                                   <span class="n">well_number</span><span class="o">=</span><span class="n">well_number</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                                   <span class="n">x_reagent_stock</span><span class="o">=</span><span class="n">x_reagent</span><span class="p">,</span>
                                   <span class="n">y_reagent_stock</span><span class="o">=</span><span class="n">y_reagent</span><span class="p">,</span>
                                   <span class="n">well_volume</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">well_volume</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">screen_html</span><span class="p">:</span>
                <span class="n">screen_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RunCsvWriter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunCsvWriter">[docs]</a><span class="k">class</span> <span class="nc">RunCsvWriter</span><span class="p">(</span><span class="n">RunSerializer</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RunCsvWriter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>

<div class="viewcode-block" id="RunCsvWriter.image_to_row"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunCsvWriter.image_to_row">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">image_to_row</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Given an :class:`Image` object, convert it into a list that could be</span>
<span class="sd">        easily written to a csv file.</span>

<span class="sd">        :param image: :class:`Image` object to convert to list</span>
<span class="sd">        :type image: Image</span>
<span class="sd">        :return: List</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">image</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Cocktail</span><span class="p">):</span>
                <span class="n">row</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">number</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Image</span><span class="p">):</span>
                <span class="n">row</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">path</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># unwrap the dict</span>
                <span class="k">for</span> <span class="n">attr_b</span><span class="p">,</span> <span class="n">value_b</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">attr_b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>  <span class="c1"># only add if will not override higher level attr</span>
                        <span class="c1"># only go one level deep for now</span>
                        <span class="n">row</span><span class="p">[</span><span class="n">attr_b</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_b</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># currently do not encode bytes (base 64 stuff)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># default to case to string</span>
        <span class="k">return</span> <span class="n">row</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the hidden attribute `_output_path`.</span>

<span class="sd">        :return: Output path</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fieldnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># could use more efficent way of determining feildnames</span>
        <span class="sd">&#39;&#39;&#39;Get the current fieldnames based on the data stored in the</span>
<span class="sd">        :attr:`~polo.utils.io_utils.RunCsvWriter.run` attribute.</span>
<span class="sd">        Currently is somewhat expensive to call since it</span>
<span class="sd">        requires parsing all records in </span>
<span class="sd">        :attr:`~polo.utils.io_utils.RunCsvWriter.run`</span>
<span class="sd">        in order to determine all the</span>
<span class="sd">        fieldnames that should be included in order to definitely avoid</span>
<span class="sd">        keyerrors later down the line.</span>

<span class="sd">        :return: List of fieldnames (headers) for the csv data </span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="n">fieldnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">fieldnames</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">fieldnames</span>

    <span class="nd">@output_path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">output_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">=</span> <span class="n">new_path</span>

<div class="viewcode-block" id="RunCsvWriter.get_csv_data"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunCsvWriter.get_csv_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_csv_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert the  :attr:`~polo.utils.io_utils.RunCsvWriter.run`</span>
<span class="sd">        attribute to csv style data. Returns a tuple of</span>
<span class="sd">        headers and a list of dictionaries with each dictionary representing</span>
<span class="sd">        one row of csv data.</span>

<span class="sd">        :return: Tuple, list of headers and list of dicts</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">fieldnames</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">fieldnames</span><span class="p">,</span> <span class="n">rows</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught and re-raised </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_csv_data</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">e</span></div>

<div class="viewcode-block" id="RunCsvWriter.write_csv"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunCsvWriter.write_csv">[docs]</a>    <span class="k">def</span> <span class="nf">write_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write the :class:`Run` object referenced by the </span>
<span class="sd">        :attr:`~polo.utils.io_utils.RunCsvWriter.run` </span>
<span class="sd">        attribute as a csv file to the location specified</span>
<span class="sd">        by the  :attr:`~polo.utils.io_utils.RunCsvWriter.output_path`</span>
<span class="sd">        attribute. </span>

<span class="sd">        :return: True, if csv file content was written successfully,</span>
<span class="sd">                 return error thrown otherwise.</span>
<span class="sd">        :rtype: Bool or Exception</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">fieldnames</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_path</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Caught exception </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_csv</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">RunCsvWriter</span><span class="o">.</span><span class="n">image_to_row</span><span class="p">(</span><span class="n">image</span><span class="p">)</span></div>

<div class="viewcode-block" id="SceneExporter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.SceneExporter">[docs]</a><span class="k">class</span> <span class="nc">SceneExporter</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graphics_scene</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graphics_scene</span> <span class="o">=</span> <span class="n">graphics_scene</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
    
<div class="viewcode-block" id="SceneExporter.write_image"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.SceneExporter.write_image">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">write_image</span><span class="p">(</span><span class="n">scene</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write the contents of a :class:`QGraphicsScene`</span>
<span class="sd">        to a png file.</span>

<span class="sd">        :param scene: :class:`QGraphicsScene` to convert to image file.</span>
<span class="sd">        :type scene: QGraphicsScene</span>
<span class="sd">        :param file_path: Path to save image to.</span>
<span class="sd">        :type file_path: str</span>
<span class="sd">        :return: File path to saved image if successful, Exception otherwise.</span>
<span class="sd">        :rtype: str or Exception</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">QImage</span><span class="p">(</span>
                <span class="n">scene</span><span class="o">.</span><span class="n">width</span><span class="p">(),</span> <span class="n">scene</span><span class="o">.</span><span class="n">height</span><span class="p">(),</span>
                <span class="n">QImage</span><span class="o">.</span><span class="n">Format_ARGB32_Premultiplied</span>
                <span class="p">)</span>
            <span class="n">painter</span> <span class="o">=</span> <span class="n">QPainter</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="n">scene</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">painter</span><span class="p">)</span>
            <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">file_path</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="n">SceneExporter</span><span class="o">.</span><span class="n">write_image</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div>
    
<div class="viewcode-block" id="SceneExporter.write"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.SceneExporter.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SceneExporter</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graphics_scene</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MsoWriter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.MsoWriter">[docs]</a><span class="k">class</span> <span class="nc">MsoWriter</span><span class="p">(</span><span class="n">RunSerializer</span><span class="p">):</span>

    <span class="n">mso_version</span> <span class="o">=</span> <span class="s1">&#39;msoversion2&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>

<div class="viewcode-block" id="MsoWriter.row_formater"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.MsoWriter.row_formater">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">row_formater</span><span class="p">(</span><span class="n">cocktail_row</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Format a cocktail row as read from a cocktail csv</span>
<span class="sd">        file to an mso file row. Main change is appending empty</span>
<span class="sd">        strings to the cocktail row so list ends up always having</span>
<span class="sd">        a length of 17. This is important because the image</span>
<span class="sd">        classification code always occurs at the 18th item in</span>
<span class="sd">        an mso file row.</span>

<span class="sd">        :param cocktail_row: Cocktail row as read from cocktail csv file.</span>
<span class="sd">        :type cocktail_row: list</span>
<span class="sd">        :return: Cocktail row reformated for mso writing.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># well number should be first index in the list</span>
        <span class="c1"># total list length should be 18 last item is the mso code</span>
        <span class="k">return</span> <span class="n">cocktail_row</span> <span class="o">+</span> <span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cocktail_row</span><span class="p">)</span> <span class="o">-</span> <span class="mi">17</span><span class="p">))</span></div>

    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create the first line of the mso file.</span>

<span class="sd">        :return: List to write as the first line of the mso file.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">MsoWriter</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run_name</span><span class="p">,</span> <span class="s1">&#39;.rar&#39;</span><span class="p">),</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">mso_version</span>
        <span class="p">]</span>
    
<div class="viewcode-block" id="MsoWriter.get_cocktail_csv_data"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.MsoWriter.get_cocktail_csv_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_cocktail_csv_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Reads and returns the cocktail csv data assigned</span>
<span class="sd">        to the  :attr:`~polo.utils.io_utils.MsoWriter.cocktail_menu`</span>
<span class="sd">        attribute of the MsoWriter&#39;s</span>
<span class="sd">        :attr:`~polo.utils.io_utils.MsoWriter.run` attribute.</span>

<span class="sd">        :return: List of lists containing cocktail csv data.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cocktail_menu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">cocktail_menu</span><span class="o">.</span><span class="n">path</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cocktail_menu</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">menu_file</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">menu_file</span><span class="p">)</span>  <span class="c1"># skip first row</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">menu_file</span><span class="p">)]</span></div>

<div class="viewcode-block" id="MsoWriter.write_mso_file"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.MsoWriter.write_mso_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_mso_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_marco_classifications</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Writes an mso formated file for use with MarcoScopeJ based on</span>
<span class="sd">        the images and classifications of the :class:`Run` instance</span>
<span class="sd">        referenced by the MsoWriter&#39;s :attr:`~polo.utils.io_utils.MsoWriter.run`</span>
<span class="sd">        attribute.</span>

<span class="sd">        :param use_marco_classifications: Include the MARCO classification</span>
<span class="sd">                                          in the mso file instead of human</span>
<span class="sd">                                          classifications, defaults to False</span>
<span class="sd">        :type use_marco_classifications: bool, optional</span>
<span class="sd">        :return: True if file is written successfully, False otherwise.</span>
<span class="sd">        :rtype: bool</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">HWIRun</span><span class="p">):</span>  <span class="c1"># must be hwi run to write to mso</span>
            <span class="n">cocktail_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cocktail_csv_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">MsoWriter</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;.mso&#39;</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>  <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mso_file</span><span class="p">:</span>
                <span class="c1"># newline=&#39;&#39; added for windows compatibility</span>
                <span class="c1"># see https://stackoverflow.com/questions/3348460/csv-file-written-with-</span>
                <span class="c1"># python-has-blank-lines-between-each-row</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">mso_file</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">first_line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_line</span><span class="p">]</span>
                <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cocktail_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">first_line</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cocktail_data</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">MsoWriter</span><span class="o">.</span><span class="n">row_formater</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">well_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">well_num</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">image</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">human_class</span><span class="p">:</span>
                        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MSO_DICT</span><span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">human_class</span><span class="p">])</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">use_marco_classifications</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">machine_class</span><span class="p">:</span>
                        <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MSO_DICT</span><span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">machine_class</span><span class="p">])</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="MsoReader"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.MsoReader">[docs]</a><span class="k">class</span> <span class="nc">MsoReader</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;The MsoReader class is used to parse the content of mso formated</span>
<span class="sd">    files and apply the image classifications stored in these files to</span>
<span class="sd">    runs in Polo.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mso_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mso_path</span> <span class="o">=</span> <span class="n">mso_path</span>
    
    
<div class="viewcode-block" id="MsoReader.read_mso_classification"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.MsoReader.read_mso_classification">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_mso_classification</span><span class="p">(</span><span class="n">mso_classification</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Helper method to read and convert image classifications in a mso</span>
<span class="sd">        file to MARCO image classifications. The exact conversion scheme is</span>
<span class="sd">        layed out in the :const:`REV_MSO_DICT` constant.</span>
<span class="sd">        Additionally, MarcoscopeJ will allow</span>
<span class="sd">        images to have multiple classifications by assigning multiple</span>
<span class="sd">        image codes seperated by &quot;-&quot;. If this is the case Polo takes the</span>
<span class="sd">        classification corresponding to the mso code with the highest value.</span>

<span class="sd">        :param mso_classification: Mso image classification code</span>
<span class="sd">        :type mso_classification: str</span>
<span class="sd">        :return: MARCO classification if code can be decoded, None otherwise</span>
<span class="sd">        :rtype: str or None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mso_classification</span> <span class="o">=</span> <span class="n">mso_classification</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

            <span class="n">mso_codes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">mso_classification</span> 
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="ow">in</span> <span class="n">REV_MSO_DICT</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mso_codes</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">REV_MSO_DICT</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">mso_codes</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="n">MsoReader</span><span class="o">.</span><span class="n">read_mso_classification</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># assume no mso classification if throws an error</span></div>

<div class="viewcode-block" id="MsoReader.classify_images_from_mso_file"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.MsoReader.classify_images_from_mso_file">[docs]</a>    <span class="k">def</span> <span class="nf">classify_images_from_mso_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Applies the image classifications stored in an mso file to a</span>
<span class="sd">        collection of :class:`~polo.crystallography.image.Image` objects.</span>
<span class="sd">        Allows for some degree of compatability</span>
<span class="sd">        with MarcoscopeJ and for users who have stored their image classifications</span>
<span class="sd">        in the mso format. Additionally, human classification backups are</span>
<span class="sd">        saved as mso files when Polo is closed as they take up much less</span>
<span class="sd">        space than xtal files.</span>

<span class="sd">        :param images: List of images to apply classifications to</span>
<span class="sd">        :type images: list</span>
<span class="sd">        :return: List of images with mso classifications applied,</span>
<span class="sd">                 or Exception if this fails</span>
<span class="sd">        :rtype: list or Exception</span>
<span class="sd">        &#39;&#39;&#39;</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mso_path</span><span class="p">))</span> <span class="k">as</span> <span class="n">mso</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">mso</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>  <span class="c1"># skip first two header lines</span>
                <span class="k">if</span> <span class="n">reader</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                        <span class="n">well_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">classification</span> <span class="o">=</span> <span class="n">MsoReader</span><span class="o">.</span><span class="n">read_mso_classification</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">images</span><span class="p">[</span><span class="n">well_index</span><span class="p">]</span><span class="o">.</span><span class="n">human_class</span> <span class="o">=</span> <span class="n">classification</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="k">continue</span>
                <span class="k">return</span> <span class="n">images</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify_images_from_mso_file</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div></div>

<div class="viewcode-block" id="JsonWriter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.JsonWriter">[docs]</a><span class="k">class</span> <span class="nc">JsonWriter</span><span class="p">(</span><span class="n">RunSerializer</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Small class that can be used to serialize a run to a</span>
<span class="sd">    json formated file.</span>

<span class="sd">    :param run: Run to write as a json file</span>
<span class="sd">    :type run: Run or HWIRun</span>
<span class="sd">    :param output_path: Path to write json file to</span>
<span class="sd">    :type output_path: str or Path</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
    
<div class="viewcode-block" id="JsonWriter.json_encoder"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.JsonWriter.json_encoder">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">json_encoder</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;General purpose json encoder for encoding python objects. Very</span>
<span class="sd">        similar to the encoder function </span>
<span class="sd">        :meth:`~polo.utils.io_utils.XtalWriter.json_encoder` except does not</span>
<span class="sd">        include class and module information in the returned dictionary. If</span>
<span class="sd">        the object cannot be converted to a dictionary it is returned as a</span>
<span class="sd">        string.   </span>

<span class="sd">        :param obj: Object to convert to dictionary</span>
<span class="sd">        :type obj: obj</span>
<span class="sd">        :return: dict or str</span>
<span class="sd">        :rtype: dict or str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">):</span>  <span class="c1"># can send to dict object</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># not castable to dict</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>  <span class="c1"># likely the base64 encoded image</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># if all else fails case to string</span>
        <span class="k">return</span> <span class="n">d</span></div>
    
<div class="viewcode-block" id="JsonWriter.write_json"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.JsonWriter.write_json">[docs]</a>    <span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write the :class:`Run` instance referenced by the :attr:`~polo.utils.io_utils.JsonWriter.run`</span>
<span class="sd">        attribute to a json file at</span>
<span class="sd">        the location specified by the</span>
<span class="sd">        :attr:`~polo.utils.io_utils.JsonWriter.output_path` attribute.</span>
<span class="sd">        If the file is written successfully returns True</span>
<span class="sd">        otherwise returns an Exception.</span>

<span class="sd">        :return: True or Exception</span>
<span class="sd">        :rtype: bool, Exception</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clean_run</span> <span class="o">=</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">clean_run_for_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
            <span class="n">json_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">clean_run</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="n">XtalWriter</span><span class="o">.</span><span class="n">json_encoder</span><span class="p">)</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">JsonWriter</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">),</span> <span class="s1">&#39;.json&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">json_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_content</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_json</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="XtalWriter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter">[docs]</a><span class="k">class</span> <span class="nc">XtalWriter</span><span class="p">(</span><span class="n">RunSerializer</span><span class="p">):</span>
    <span class="n">header_flag</span> <span class="o">=</span> <span class="s1">&#39;&lt;&gt;&#39;</span>  <span class="c1"># do not change unless very good reason</span>
    <span class="n">header_line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">:</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">file_ext</span> <span class="o">=</span> <span class="s1">&#39;.xtal&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">main_window</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span> <span class="o">=</span> <span class="n">main_window</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">XtalWriter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xtal_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creates the header for an xtal file when called. Header lines are</span>
<span class="sd">        indicated as such by the string in the header_line constant,</span>
<span class="sd">        which should be &#39;&lt;&gt;&#39;. The last line of the header will be a row</span>
<span class="sd">        of equal signs and then the actual json content begins on the</span>
<span class="sd">        next line.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">header</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header_flag</span><span class="p">,</span> <span class="s1">&#39;SAVE TIME&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">header</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header_flag</span><span class="p">,</span> <span class="s1">&#39;VERSION&#39;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_flag</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">79</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1"># add ==== as a break between json data and header data</span>

<div class="viewcode-block" id="XtalWriter.json_encoder"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.json_encoder">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">json_encoder</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Use instead of the default json encoder when writing an xtal file. </span>
<span class="sd">        If the encoded object is from a module within Polo will include a </span>
<span class="sd">        module and class identifier so it can be more easily deserialized </span>
<span class="sd">        when loaded back into the program.</span>

<span class="sd">        :param: obj: An object to serialize to json.</span>

<span class="sd">        :returns: A dictionary or string version of the passed object</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">):</span>  <span class="c1"># can send to dict object</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;__class__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;__module__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span>
            <span class="c1"># store module and class name along with object as dict</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># not castable to dict</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>  <span class="c1"># likely the base64 encoded image</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># if all else fails case to string</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="XtalWriter.clean_run_for_save"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.clean_run_for_save">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_run_for_save</span><span class="p">(</span><span class="n">run</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove circular references from the run passed through the `run`</span>
<span class="sd">        argument to avoid issues when writing to json files.</span>

<span class="sd">        :param run: Run to clean (remove circular references)</span>
<span class="sd">        :type run: Run or HWIRun</span>
<span class="sd">        :return: Run, free from circular references</span>
<span class="sd">        :rtype: Run or HWIRun</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">run</span><span class="p">:</span>
            <span class="n">run</span><span class="o">.</span><span class="n">previous_run</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">next_run</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">alt_spectrum</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
                    <span class="n">image</span><span class="o">.</span><span class="n">previous_image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">next_image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">alt_image</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">run</span></div>

<div class="viewcode-block" id="XtalWriter.write_xtal_file_on_thread"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.write_xtal_file_on_thread">[docs]</a>    <span class="k">def</span> <span class="nf">write_xtal_file_on_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper method around :meth:`~polo.utils.io_utils.XtalWriter.write_xtal_file` </span>
<span class="sd">        that executes on a :class:`QuickThread` instance to prevent freezing the </span>
<span class="sd">        GUI when saving large xtal files</span>

<span class="sd">        :param output_path: Path to xtal file</span>
<span class="sd">        :type output_path: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">make_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_xtal_file</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>
        <span class="c1"># connect to something when thread finishes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished_save</span><span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">setOverrideCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WaitCursor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="XtalWriter.finished_save"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.finished_save">[docs]</a>    <span class="k">def</span> <span class="nf">finished_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_window</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">restoreOverrideCursor</span><span class="p">()</span>  <span class="c1"># return cursor to normal</span>
        <span class="c1"># should contain path to now saved file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">result</span><span class="p">)):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Saved current run to </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Save to failed. Returned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>

        <span class="n">make_message_box</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span></div>

<div class="viewcode-block" id="XtalWriter.write_xtal_file"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.write_xtal_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_xtal_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Method to serialize run object to xtal file format.</span>

<span class="sd">        :param output_path: Xtal file path</span>
<span class="sd">        :type output_path: str</span>
<span class="sd">        :return: path to xtal file</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">path_validator</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="c1"># path is good to go and ready to write file into</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">encode_images_to_base64</span><span class="p">()</span>
            <span class="n">run_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># encoding worked, no errors caught</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_ext</span><span class="p">)</span>  <span class="c1"># make sure has .xtal suffix</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xtal_file</span><span class="p">:</span>
                        <span class="n">xtal_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtal_header</span><span class="p">)</span>
                        <span class="n">xtal_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_str</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">output_path</span>
                <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_xtal_file</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="XtalWriter.run_to_dict"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.run_to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">run_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a json string from the run stored in the run attribute.</span>

<span class="sd">        :return: Run instance serialized to json</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">clean_run</span> <span class="o">=</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">clean_run_for_save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
                <span class="n">clean_run</span><span class="o">.</span><span class="n">encode_images_to_base64</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">clean_run</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="n">XtalWriter</span><span class="o">.</span><span class="n">json_encoder</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to encode </span><span class="si">{}</span><span class="s1"> to dict. Gave </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="RunDeserializer"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer">[docs]</a><span class="k">class</span> <span class="nc">RunDeserializer</span><span class="p">():</span>  <span class="c1"># convert saved file into a run</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtal_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xtal_path</span> <span class="o">=</span> <span class="n">xtal_path</span>

<div class="viewcode-block" id="RunDeserializer.clean_base64_string"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.clean_base64_string">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_base64_string</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">out_fmt</span><span class="o">=</span><span class="nb">bytes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Image instances may contain byte strings that store their actual</span>
<span class="sd">        crystallization image encoded as base64. Previously, these byte strings</span>
<span class="sd">        were written directly into the json file as strings causing the b&#39;</span>
<span class="sd">        byte string identifier to be written along with the actual base64 data.</span>
<span class="sd">        This method removes those artifacts if they are present and returns a</span>
<span class="sd">        clean byte string with only the actual base64 data.</span>

<span class="sd">        :param string: a string to interrogate</span>
<span class="sd">        :type string: str</span>
<span class="sd">        :return: byte string with non-data artifacts removed</span>
<span class="sd">        :rtype: bytes</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">string</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>  <span class="c1"># bytes string written directly to string</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">string</span><span class="p">:</span> 
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_fmt</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">string</span></div>
            
<div class="viewcode-block" id="RunDeserializer.dict_to_obj"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.dict_to_obj">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dict_to_obj</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Opposite of the obj_to_dict method in XtalWriter class, this method</span>
<span class="sd">        takes a dictionary instance that has been previously serialized and</span>
<span class="sd">        attempts to convert it back into an object instance. Used as the</span>
<span class="sd">        `object_hook` argument when calling `json.loads` to read xtal files.</span>

<span class="sd">        :param d: dictionary to convert back to object</span>
<span class="sd">        :type d: dict</span>
<span class="sd">        :return: an object</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;__class__&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>  <span class="c1"># is a serialized object</span>
                <span class="n">class_name</span><span class="p">,</span> <span class="n">mod_name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__class__&#39;</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__module__&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">mod_name</span><span class="p">)</span>
                    <span class="n">class_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="n">RunDeserializer</span><span class="o">.</span><span class="n">dict_to_obj</span><span class="p">))</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">temp_d</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;__&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>  <span class="c1"># deal with object properties</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s1">&#39;_&#39;</span> <span class="o">==</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">temp_d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">class_</span><span class="p">(</span><span class="o">**</span><span class="n">temp_d</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Image</span><span class="p">):</span>  <span class="c1"># clean up base64 encoded data</span>
                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">bites</span><span class="p">:</span>
                        <span class="n">obj</span><span class="o">.</span><span class="n">bites</span> <span class="o">=</span> <span class="n">RunDeserializer</span><span class="o">.</span><span class="n">clean_base64_string</span><span class="p">(</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">bites</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">d</span>  <span class="c1"># just a regular dictionary to read in</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="RunDeserializer.xtal_to_run_on_thread"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.xtal_to_run_on_thread">[docs]</a>    <span class="k">def</span> <span class="nf">xtal_to_run_on_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Wrapper method around `xtal_to_run` method. Does the exact same thing</span>
<span class="sd">        except creates a `QuickThread` instance and runs `xtal_to_run` on the</span>
<span class="sd">        thread. When finished adds the newly created run to the main window&#39;s</span>
<span class="sd">        loaded_run dictionary to signify that the run has been loaded and is</span>
<span class="sd">        ready for further operations.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">QuickThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtal_to_run</span><span class="p">,</span> <span class="n">xtal_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xtal_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="RunDeserializer.make_read_xtal_thread"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.make_read_xtal_thread">[docs]</a>    <span class="k">def</span> <span class="nf">make_read_xtal_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QuickThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtal_to_run</span><span class="p">,</span> <span class="n">xtal_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xtal_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunDeserializer.xtal_header_reader"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.xtal_header_reader">[docs]</a>    <span class="k">def</span> <span class="nf">xtal_header_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtal_file_io</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Reads the header section of an open xtal file. Should always be</span>
<span class="sd">        called before reading the json content of an xtal file. Note than</span>
<span class="sd">        xtal files must always have a line of equal signs before the json</span>
<span class="sd">        content even if there is no header content otherwise this method will</span>
<span class="sd">        read one line into the json content causing the json reader to</span>
<span class="sd">        throw an error.</span>

<span class="sd">        :param xtal_file_io: xtal file currently being read</span>
<span class="sd">        :type xtal_file_io: TextIoWrapper</span>
<span class="sd">        :return: xtal header contents</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># pulls info in the header of an xtal file</span>
        <span class="n">header_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">xtal_file_io</span><span class="o">.</span><span class="n">readline</span><span class="p">()]</span>
        <span class="k">while</span> <span class="n">header_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">XtalWriter</span><span class="o">.</span><span class="n">header_flag</span><span class="p">)]</span> <span class="o">==</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">header_flag</span><span class="p">:</span>
            <span class="n">header_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xtal_file_io</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">header_data</span></div>

<div class="viewcode-block" id="RunDeserializer.xtal_to_run"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.xtal_to_run">[docs]</a>    <span class="k">def</span> <span class="nf">xtal_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Attempt to convert the file specified by the path stored in the</span>
<span class="sd">        :attr:`~polo.utils.io_utils.RunDeserializer.xtal_path`</span>
<span class="sd">        attribute to a :class:`Run` object. </span>

<span class="sd">        :return: Run object encoded by an xtal file</span>
<span class="sd">        :rtype: Run</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;xtal_path&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">xtal_path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xtal_path&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xtal_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xtal_path</span>
            <span class="n">xtal_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xtal_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">xtal_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">xtal_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">xtal_data</span><span class="p">:</span>
                    <span class="n">header_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xtal_header_reader</span><span class="p">(</span>
                        <span class="n">xtal_data</span><span class="p">)</span>  <span class="c1"># must read header first</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">xtal_data</span><span class="p">,</span>  <span class="c1"># update date since datetime goes right to string</span>
                                <span class="n">object_hook</span><span class="o">=</span><span class="n">RunDeserializer</span><span class="o">.</span><span class="n">dict_to_obj</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">BarTender</span><span class="o">.</span><span class="n">datetime_converter</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">save_file_path</span> <span class="o">=</span> <span class="n">xtal_path</span>
                    <span class="k">return</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="ne">FileNotFoundError</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xtal_to_run</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="PptxWriter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter">[docs]</a><span class="k">class</span> <span class="nc">PptxWriter</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Use for creating pptx presentation slides from :class:`Run`</span>
<span class="sd">    or :class:`HWIRun` instances.</span>

<span class="sd">    :param output_path: Path to write pptx file to.</span>
<span class="sd">    :type output_path: str or Path</span>
<span class="sd">    :param included_attributes: [description], defaults to {}</span>
<span class="sd">    :type included_attributes: dict, optional</span>
<span class="sd">    :param image_types: Images included in the presentation</span>
<span class="sd">                        must have a classification in this set, defaults to None</span>
<span class="sd">    :type image_types: set or list, optional</span>
<span class="sd">    :param human: Use human classification as the image classification, defaults to False</span>
<span class="sd">    :type human: bool, optional</span>
<span class="sd">    :param marco: Use the MARCO classification as the image classification, defaults to False</span>
<span class="sd">    :type marco: bool, optional</span>
<span class="sd">    :param favorite: Only include images marked as favorite, defaults to False</span>
<span class="sd">    :type favorite: bool, optional</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># 13.33 x 7.5 </span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span>
                 <span class="n">image_types</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">human</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">marco</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">favorite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">human</span> <span class="o">=</span> <span class="n">human</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marco</span> <span class="o">=</span> <span class="n">marco</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">favorite</span> <span class="o">=</span> <span class="n">favorite</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_types</span> <span class="o">=</span> <span class="n">image_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slide_width</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slide_height</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_presentation</span> <span class="o">=</span> <span class="n">Presentation</span><span class="p">()</span>
    
<div class="viewcode-block" id="PptxWriter.delete_presentation"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.delete_presentation">[docs]</a>    <span class="k">def</span> <span class="nf">delete_presentation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_presentation</span> <span class="o">=</span> <span class="n">Presentation</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="PptxWriter.delete_temp_images"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.delete_temp_images">[docs]</a>    <span class="k">def</span> <span class="nf">delete_temp_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Delete an temporary images used to create the pptx presentation.</span>

<span class="sd">        :return: True, if images are removed successfully, Exception otherwise.</span>
<span class="sd">        :rtype: bool or Exception</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_images</span><span class="p">]</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">IsADirectoryError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_temp_images</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div>
    
<div class="viewcode-block" id="PptxWriter.sort_runs_by_spectrum"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.sort_runs_by_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">sort_runs_by_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Divids runs into two lists, one containing visible spectrum</span>
<span class="sd">        runs and another containing all non-visible runs.</span>

<span class="sd">        :param runs: List or runs</span>
<span class="sd">        :type runs: list</span>
<span class="sd">        :return: tuple, first item is visible runs second is non-visible runs</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">visible</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">image_spectrum</span> <span class="o">==</span> <span class="n">IMAGE_SPECS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">visible</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">visible</span><span class="p">,</span> <span class="n">other</span></div>
           
    <span class="c1"># def make_sample_presentation(self, sample_name, runs, title,</span>
    <span class="c1">#                              subtitle, cocktail_data=True):</span>
    <span class="c1">#     &#39;&#39;&#39;Create a pptx presentation from a collection of runs intended to</span>
    <span class="c1">#     be all of the same sample. This allows for time resolved comparisons</span>
    <span class="c1">#     and comparisons between spectrums. Should generally not include all</span>
    <span class="c1">#     images in the presentation or with runs who&#39;s images do not exist</span>
    <span class="c1">#     on the local machine. Doing so creates huge presentation files and</span>
    <span class="c1">#     long write times.</span>

    <span class="c1">#     :param sample_name: Name of the sample</span>
    <span class="c1">#     :type sample_name: str</span>
    <span class="c1">#     :param runs: List of runs to include in the presentation</span>
    <span class="c1">#     :type runs: list</span>
    <span class="c1">#     :param title: Title of the presentation</span>
    <span class="c1">#     :type title: str</span>
    <span class="c1">#     :param subtitle: Subtitle of the presentation</span>
    <span class="c1">#     :type subtitle: str</span>
    <span class="c1">#     :param cocktail_data: Include cocktail data if True, defaults to True</span>
    <span class="c1">#     :type cocktail_data: bool, optional</span>
    <span class="c1">#     :return: Path to presentation file if write is successful, False otherwise</span>
    <span class="c1">#     :rtype: str or bool</span>
    <span class="c1">#     &#39;&#39;&#39;</span>
    <span class="c1">#     visible, other = self.sort_runs_by_spectrum(runs)</span>
    <span class="c1">#     title_slide = self.add_new_slide(0)</span>
    <span class="c1">#     title_slide.shapes.title.text = title</span>
    <span class="c1">#     if subtitle:</span>
    <span class="c1">#         title_slide.placeholders[1].text = subtitle</span>

    <span class="c1">#     try:</span>
    <span class="c1">#         if visible or other:</span>
    <span class="c1">#             show_all_dates, show_single_image, show_alt_specs = False, False, False</span>
    <span class="c1">#             if visible:</span>
    <span class="c1">#                 if len(visible) &gt; 1:</span>
    <span class="c1">#                     show_all_dates = True</span>
    <span class="c1">#                 else:</span>
    <span class="c1">#                     show_single_image = True</span>
    <span class="c1">#             if other:</span>
    <span class="c1">#                 show_alt_specs = True</span>

    <span class="c1">#             if show_all_dates or show_single_image:</span>
    <span class="c1">#                 rep_run = visible[0]</span>
    <span class="c1">#             else:</span>
    <span class="c1">#                 rep_run = other[0]</span>
                
    <span class="c1">#             for i in range(10):</span>
    <span class="c1">#                 if show_all_dates:</span>
    <span class="c1">#                     self.add_timeline_slide([r.images[i] for r in visible], i+1)</span>
    <span class="c1">#                 elif show_single_image:</span>
    <span class="c1">#                     metadata = str(rep_run.images[i])</span>
    <span class="c1">#                     if hasattr(rep_run.images[i], &#39;cocktail&#39;) and cocktail_data:</span>
    <span class="c1">#                         metadata += &#39;\n\n&#39; + str(rep_run.images[i].cocktail)</span>
    <span class="c1">#                     title = &#39;Well Number {}&#39;.format(rep_run.images[i].well_number)</span>
    <span class="c1">#                     self.add_single_image_slide(rep_run.images[i], title, metadata)</span>
                    
    <span class="c1">#                 if show_alt_specs:</span>
    <span class="c1">#                     well_number = i + 1</span>
    <span class="c1">#                     self.add_multi_spectrum_slide([r.images[i] for r in other], well_number)</span>
                
    <span class="c1">#             self._presentation.save(str(self.output_path))</span>
    <span class="c1">#             self.delete_temp_images()</span>
    <span class="c1">#             return True</span>
                    
    <span class="c1">#         else:</span>
    <span class="c1">#             return False</span>
    <span class="c1">#     except Exception as e:</span>
    <span class="c1">#         return e</span>
        

<div class="viewcode-block" id="PptxWriter.make_single_run_presentation"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.make_single_run_presentation">[docs]</a>    <span class="k">def</span> <span class="nf">make_single_run_presentation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">subtitle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">cocktail_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">all_specs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">all_dates</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">title_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_new_slide</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">title_slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">title</span>
            <span class="k">if</span> <span class="n">subtitle</span><span class="p">:</span>
                <span class="n">title_slide</span><span class="o">.</span><span class="n">placeholders</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">subtitle</span>
            
            <span class="n">slide_title_formater</span> <span class="o">=</span> <span class="s1">&#39;Well Number </span><span class="si">{}</span><span class="s1">&#39;</span>
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">standard_filter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_types</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">human</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">marco</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">favorite</span><span class="p">):</span>
                    <span class="n">metadata</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cocktail_data</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s1">&#39;cocktail&#39;</span><span class="p">):</span>
                        <span class="n">metadata</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">cocktail</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_single_image_slide</span><span class="p">(</span>
                        <span class="n">image</span><span class="p">,</span> 
                        <span class="n">slide_title_formater</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">well_number</span><span class="p">),</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="n">all_specs</span> <span class="ow">and</span> <span class="n">image</span><span class="o">.</span><span class="n">alt_image</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_multi_spectrum_slide</span><span class="p">(</span>
                            <span class="n">image</span><span class="o">.</span><span class="n">get_linked_images_by_spectrum</span><span class="p">(),</span> <span class="n">image</span><span class="o">.</span><span class="n">well_number</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">all_dates</span> <span class="ow">and</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">next_image</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">previous_image</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_timeline_slide</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">get_linked_images_by_date</span><span class="p">(),</span> <span class="n">image</span><span class="o">.</span><span class="n">well_number</span><span class="p">)</span>


            
            <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">RunSerializer</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;.pptx&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_presentation</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_temp_images</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_single_run_presentation</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div>
                
    
<div class="viewcode-block" id="PptxWriter.add_classification_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_classification_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_classification_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">well_number</span><span class="p">,</span> <span class="n">rep_image</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a slide containing details about an images MARCO</span>
<span class="sd">        and human classification in a table.</span>

<span class="sd">        :param well_number: Well number (index) of image to use in</span>
<span class="sd">                            the title of the slide </span>
<span class="sd">        :type well_number: int</span>
<span class="sd">        :param rep_image: Image object to make slide from</span>
<span class="sd">        :type rep_image: Image</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_new_slide</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Well </span><span class="si">{}</span><span class="s1"> Classifications&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">well_number</span><span class="p">)</span>
        <span class="n">new_slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">title</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s1">&#39;Human Classification&#39;</span><span class="p">,</span> <span class="s1">&#39;MARCO Classification&#39;</span><span class="p">]</span>
            <span class="p">[</span><span class="n">rep_image</span><span class="o">.</span><span class="n">human_class</span><span class="p">,</span> <span class="n">rep_image</span><span class="o">.</span><span class="n">machine_class</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_table_to_slide</span><span class="p">(</span><span class="n">new_slide</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>
        <span class="c1"># do for most recent human classification image if it exits</span>

<div class="viewcode-block" id="PptxWriter.add_new_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_new_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_new_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presentation</span><span class="o">.</span><span class="n">slides</span><span class="o">.</span><span class="n">add_slide</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_presentation</span><span class="o">.</span><span class="n">slide_layouts</span><span class="p">[</span><span class="n">template</span><span class="p">])</span></div>
    
<div class="viewcode-block" id="PptxWriter.add_timeline_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_timeline_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_timeline_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">well_number</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a timeline (time resolved) slide that</span>
<span class="sd">        show the progression of a sample in a particular</span>
<span class="sd">        well.</span>

<span class="sd">        :param images: List of images to include in the slide</span>
<span class="sd">        :type images: list</span>
<span class="sd">        :param well_number: Well number to use in the title of the slide</span>
<span class="sd">        :type well_number: int</span>
<span class="sd">        :return: New slide</span>
<span class="sd">        :rtype: slide</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">date_images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">new_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_new_slide</span><span class="p">()</span>
        <span class="n">labeler</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">formated_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_multi_image_slide</span><span class="p">(</span><span class="n">new_slide</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">labeler</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Well </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">well_number</span><span class="p">,</span> <span class="n">date_images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">formated_date</span><span class="p">,</span> <span class="n">date_images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">formated_date</span><span class="p">)</span>
        <span class="n">new_slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">title</span>

        <span class="k">return</span> <span class="n">new_slide</span></div>
    

<div class="viewcode-block" id="PptxWriter.add_multi_spectrum_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_multi_spectrum_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_multi_spectrum_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">well_number</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a slide to show a all spectrums a well has been</span>
<span class="sd">        imaged in.</span>

<span class="sd">        :param images: Images to include on the slide</span>
<span class="sd">        :type images: list</span>
<span class="sd">        :param well_number: Well number to use in the slide title</span>
<span class="sd">        :type well_number: int</span>
<span class="sd">        :return: New slide</span>
<span class="sd">        :rtype: slide</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">spec_images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">spectrum</span><span class="p">))</span>
        <span class="n">new_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_new_slide</span><span class="p">()</span>
        <span class="n">labeler</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">spectrum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_multi_image_slide</span><span class="p">(</span><span class="n">new_slide</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">labeler</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Well </span><span class="si">{}</span><span class="s1"> Alternate Imagers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">well_number</span><span class="p">)</span>
        <span class="n">new_slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">title</span>

        <span class="k">return</span> <span class="n">new_slide</span></div>
    
<div class="viewcode-block" id="PptxWriter.add_cocktail_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_cocktail_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_cocktail_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">well</span><span class="p">,</span> <span class="n">cocktail</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add slide with details on :class:`Cocktail` information.</span>

<span class="sd">        :param well: Well number to use in slide title</span>
<span class="sd">        :type well: int</span>
<span class="sd">        :param cocktail: Cocktail to write as a slide</span>
<span class="sd">        :type cocktail: Cocktail</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_new_slide</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Well </span><span class="si">{}</span><span class="s1"> Cocktail: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">well</span><span class="p">,</span> <span class="n">cocktail</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
        <span class="n">new_slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">title</span></div>

<div class="viewcode-block" id="PptxWriter.add_table_to_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_table_to_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_table_to_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;General helper method for adding a table to a slide.</span>

<span class="sd">        :param slide: Slide to add the table to</span>
<span class="sd">        :type slide: slide</span>
<span class="sd">        :param data: List of lists that has the data to write to the table</span>
<span class="sd">        :type data: list</span>
<span class="sd">        :param left: Left offset in inches to place to table</span>
<span class="sd">        :type left: float</span>
<span class="sd">        :param top: Top cordinate for placing the table</span>
<span class="sd">        :type top: float</span>
<span class="sd">        :return: Slide with table added</span>
<span class="sd">        :rtype: slide</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">shapes</span>
        
        <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_width</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_height</span> <span class="o">-</span> <span class="mi">2</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">Inches</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="n">Inches</span><span class="p">(</span><span class="n">top</span><span class="p">),</span> 
                                 <span class="n">Inches</span><span class="p">(</span><span class="n">width</span><span class="p">),</span> <span class="n">Inches</span><span class="p">(</span><span class="n">height</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slide_size</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">cols</span>
            <span class="c1"># set column width</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
                <span class="n">table</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">slide</span></div>

<div class="viewcode-block" id="PptxWriter.add_multi_image_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_multi_image_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_multi_image_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">labeler</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;General helper method for adding a slide that will have multiple</span>
<span class="sd">        images.</span>

<span class="sd">        :param slide: Slide to add the images to </span>
<span class="sd">        :type slide: slide</span>
<span class="sd">        :param images: Images to add to the slide</span>
<span class="sd">        :type images: list</span>
<span class="sd">        :param labeler: Function to use to label the individual images</span>
<span class="sd">        :type labeler: func</span>
<span class="sd">        :return: slide with images added</span>
<span class="sd">        :rtype: slide</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">top</span> <span class="o">=</span> <span class="mf">2.5</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_slide_width</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img_size</span> <span class="o">&gt;=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_height</span><span class="p">:</span> <span class="n">img_size</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_height</span>

        <span class="n">left</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_slide_width</span> <span class="o">-</span> <span class="p">(</span><span class="n">img_size</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.2</span>

        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_image_to_slide</span><span class="p">(</span>
                <span class="n">image</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">img_size</span>
            <span class="p">)</span>
            <span class="n">label_text</span> <span class="o">=</span> <span class="n">labeler</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_text_to_slide</span><span class="p">(</span>
                <span class="n">slide</span><span class="p">,</span> <span class="n">label_text</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span> <span class="o">+</span> <span class="p">(</span><span class="n">img_size</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">),</span> <span class="n">img_size</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> 
                <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="n">left</span> <span class="o">+=</span> <span class="n">img_size</span>
        <span class="k">return</span> <span class="n">slide</span></div>
    
<div class="viewcode-block" id="PptxWriter.add_single_image_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_single_image_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_single_image_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">img_scaler</span><span class="o">=</span><span class="mf">0.65</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;General helper method for adding a slide with a single image to a</span>
<span class="sd">        presentation.</span>

<span class="sd">        :param image: Image to add to the slide</span>
<span class="sd">        :type image: Image</span>
<span class="sd">        :param title: Title to use for the slide</span>
<span class="sd">        :type title: str</span>
<span class="sd">        :param metadata: Additional information to write to the slide, defaults to None</span>
<span class="sd">        :type metadata: str, optional</span>
<span class="sd">        :param img_scaler: Scaler to apply to size of the image, defaults to 0.65</span>
<span class="sd">                            ,should be between 0 and 1. 1 is full sized image.</span>
<span class="sd">        :type img_scaler: float, optional</span>
<span class="sd">        :return: The new slide with Image added</span>
<span class="sd">        :rtype: slide</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">new_slide</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_new_slide</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">new_slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">title</span>
        <span class="n">img_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_height</span> <span class="o">*</span> <span class="n">img_scaler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_image_to_slide</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">new_slide</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">img_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">metadata_offset</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span> <span class="o">+</span> <span class="n">img_size</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_width</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span>
            <span class="n">metadata_left</span> <span class="o">=</span> <span class="n">img_size</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">metadata_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_width</span> <span class="o">-</span> <span class="n">metadata_left</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span>
            <span class="n">metadata_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slide_height</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bumper</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_text_to_slide</span><span class="p">(</span>
                <span class="n">new_slide</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">metadata_left</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">metadata_width</span><span class="p">,</span>
                <span class="n">metadata_height</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_slide</span></div>
        
    
<div class="viewcode-block" id="PptxWriter.add_text_to_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_text_to_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_text_to_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
                          <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">14</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Helper method to add text to a slide</span>

<span class="sd">        :param slide: Slide to add text to</span>
<span class="sd">        :type slide: slide</span>
<span class="sd">        :param text: Text to add to the slide</span>
<span class="sd">        :type text: str</span>
<span class="sd">        :param left: Left cordinate location of the text in inches</span>
<span class="sd">        :type left: float</span>
<span class="sd">        :param top: Top cordinate location of the text in inches</span>
<span class="sd">        :type top: float</span>
<span class="sd">        :param width: Width of the text in inches</span>
<span class="sd">        :type width: float</span>
<span class="sd">        :param height: Height of the text in inches</span>
<span class="sd">        :type height: float</span>
<span class="sd">        :param rotation: Rotation to apply to the text in degrees, defaults to 0</span>
<span class="sd">        :type rotation: int, optional</span>
<span class="sd">        :param font_size: Font size of text, defaults to 14</span>
<span class="sd">        :type font_size: int, optional</span>
<span class="sd">        :return: Slide with text added</span>
<span class="sd">        :rtype: slide</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">text_box</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">add_textbox</span><span class="p">(</span>
            <span class="n">Inches</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="n">Inches</span><span class="p">(</span><span class="n">top</span><span class="p">),</span> <span class="n">Inches</span><span class="p">(</span><span class="n">width</span><span class="p">),</span> <span class="n">Inches</span><span class="p">(</span><span class="n">height</span><span class="p">))</span>
        <span class="n">text_box</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="n">rotation</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="n">text_box</span><span class="o">.</span><span class="n">text_frame</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">word_wrap</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_paragraph</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
        <span class="n">p</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">Pt</span><span class="p">(</span><span class="n">font_size</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">text_box</span></div>
    
<div class="viewcode-block" id="PptxWriter.add_image_to_slide"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.PptxWriter.add_image_to_slide">[docs]</a>    <span class="k">def</span> <span class="nf">add_image_to_slide</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">slide</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">height</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Helper method for adding images to a slide. If the :class:`Image`</span>
<span class="sd">        does not have a file written on the local machine as can be</span>
<span class="sd">        the case with saved runs who&#39;s image data only exists in</span>
<span class="sd">        their xtal files this method will write a temporary image</span>
<span class="sd">        file to the Polo :const:`TEMP_DIR` which then should be deleted after</span>
<span class="sd">        the presentaton file is written.</span>

<span class="sd">        :param image: Image to add to the slide</span>
<span class="sd">        :type image: Image</span>
<span class="sd">        :param slide: Slide to add the image to</span>
<span class="sd">        :type slide: slide</span>
<span class="sd">        :param left: Left cordinate location of the image in inches</span>
<span class="sd">        :type left: float</span>
<span class="sd">        :param top: Top cordinate location of the image in inches</span>
<span class="sd">        :type top: float</span>
<span class="sd">        :param height: Height of the image in inches</span>
<span class="sd">        :type height: float</span>
<span class="sd">        :return: []</span>
<span class="sd">        :rtype: [type]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">temp_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">TEMP_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">path</span><span class="p">))))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">decodebytes</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">bites</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_temp_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_path</span><span class="p">)</span>
            <span class="n">img_path</span> <span class="o">=</span> <span class="n">temp_path</span>
        
        <span class="k">return</span> <span class="n">slide</span><span class="o">.</span><span class="n">shapes</span><span class="o">.</span><span class="n">add_picture</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">Inches</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="n">Inches</span><span class="p">(</span><span class="n">top</span><span class="p">),</span> 
                                        <span class="n">height</span><span class="o">=</span><span class="n">Inches</span><span class="p">(</span><span class="n">height</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="BarTender"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender">[docs]</a><span class="k">class</span> <span class="nc">BarTender</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Class for organizing and accessing </span>
<span class="sd">    :class:`~polo.utils.io_utils.Menu` data.</span>

<span class="sd">    :param cocktail_dir: Directory containing cocktail menu csv filepaths</span>
<span class="sd">    :type cocktail_dir: str or Path</span>
<span class="sd">    :param cocktail_meta: Path to cocktail metadata file which describes the contents of</span>
<span class="sd">                            each cocktail menu csv file</span>
<span class="sd">    :type cocktail_meta: Path or str</span>

<span class="sd">    Cocktail metadata file should be a csv file with the following</span>
<span class="sd">    headers ordered from top to bottom. Each header name is followed by a</span>
<span class="sd">    description.</span>

<span class="sd">    .. code-block:: text</span>

<span class="sd">        File Name: Name of cocktail menu file</span>
<span class="sd">        Dates Used: Range of dates the cocktail menu was used (m/d/y-m/d/y)</span>
<span class="sd">        Plate Number</span>
<span class="sd">        Screen Type: &#39;m&#39; for membrane screens, &#39;s&#39; for soluble screens</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cocktail_dir</span><span class="p">,</span> <span class="n">cocktail_meta</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_dir</span> <span class="o">=</span> <span class="n">cocktail_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_meta</span> <span class="o">=</span> <span class="n">cocktail_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menus</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_menus_from_metadata</span><span class="p">()</span>

<div class="viewcode-block" id="BarTender.datetime_converter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.datetime_converter">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">datetime_converter</span><span class="p">(</span><span class="n">date_string</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;General utility function for converting strings to datetime objects.</span>
<span class="sd">        Attempts to convert the string by trying a couple of datetime</span>
<span class="sd">        formats that are common in cocktail menu files and other</span>
<span class="sd">        locations in the HWI file universe Polo runs across.</span>

<span class="sd">        :param date_string: string to convert to datetime</span>
<span class="sd">        :type date_string: str</span>
<span class="sd">        :return: datetime object</span>
<span class="sd">        :rtype: datetime</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">date_string</span> <span class="o">=</span> <span class="n">date_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">datetime_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">,</span> <span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%y&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">-%Y&#39;</span><span class="p">,</span> <span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">-%y&#39;</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">datetime_formats</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">continue</span></div>

<div class="viewcode-block" id="BarTender.date_range_parser"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.date_range_parser">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">date_range_parser</span><span class="p">(</span><span class="n">date_range_string</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Utility function for converting the date ranges in the cocktail</span>
<span class="sd">        metadata csv file to datetime objects using the </span>
<span class="sd">        :meth:`~polo.utils.io_utils.BarTender.datetime_converter`</span>
<span class="sd">        method.</span>

<span class="sd">        Date ranges should have the format</span>

<span class="sd">        .. code-block:: text</span>

<span class="sd">            &#39;start date - end date&#39;</span>

<span class="sd">            If the date range is for the most recent cocktail menu then there</span>
<span class="sd">            will not be an end date and the format will be</span>

<span class="sd">            &#39;start date - &#39;</span>

<span class="sd">        :param date_range_string: string to pull dates out of   </span>
<span class="sd">        :type date_range_string: str</span>
<span class="sd">        :return: tuple of datetime objects, start date and end date</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">date_range_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">BarTender</span><span class="o">.</span><span class="n">datetime_converter</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">BarTender</span><span class="o">.</span><span class="n">datetime_converter</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span></div>

<div class="viewcode-block" id="BarTender.add_menus_from_metadata"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.add_menus_from_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_menus_from_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds :class:`Menu` objects to the :attr:polo.utils.io_utils.BarTender.menus`</span>
<span class="sd">        attribute by reading the cocktail csv files included</span>
<span class="sd">        in the :const:`COCKTAIL_DATA_PATH` directory.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_meta</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cocktail_meta</span><span class="p">))</span> <span class="k">as</span> <span class="n">menu_files</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">menu_files</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">COCKTAIL_DATA_PATH</span><span class="p">),</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;File Name&#39;</span><span class="p">])</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">BarTender</span><span class="o">.</span><span class="n">date_range_parser</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Dates Used&#39;</span><span class="p">])</span>
                    <span class="n">new_menu</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Screen Type&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_menu</span></div>
                    <span class="c1"># add new menu to menus dict path to csv file is the menu</span>
                    <span class="c1"># key</span>

<div class="viewcode-block" id="BarTender.get_menu_by_date"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.get_menu_by_date">[docs]</a>    <span class="k">def</span> <span class="nf">get_menu_by_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a :class:`Menu` instance who&#39;s usage dates include the</span>
<span class="sd">        date passed through the `date` argument and</span>
<span class="sd">        matches the screen type passed through the `type_` argument.</span>

<span class="sd">        Screen types can either be &#39;s&#39; for &#39;soluble&#39; screens or &#39;m&#39; for</span>
<span class="sd">        membrane screens.</span>

<span class="sd">        :param date: Date to search menus with</span>
<span class="sd">        :type date: datetime</span>
<span class="sd">        :param type_: Type of screen to return (soluble or membrane)</span>
<span class="sd">        :type type_: str</span>
<span class="sd">        :return: menu matching the given date and type</span>
<span class="sd">        :rtype: Menu</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">menus_keys_by_date</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">type_</span> <span class="o">==</span> <span class="n">type_</span><span class="p">],</span>
                <span class="c1"># keys matching only the specified type</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">start_date</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="c1"># search for a menu whos usage dates include this date</span>
            <span class="c1"># end up with a list of keys for menus of the specified type that</span>
            <span class="c1"># are sorted by the start date of their use at HWI cente</span>
            <span class="k">for</span> <span class="n">each_key</span> <span class="ow">in</span> <span class="n">menus_keys_by_date</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">each_key</span><span class="p">]</span><span class="o">.</span><span class="n">start_date</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">each_key</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">menus_keys_by_date</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span></div>


<div class="viewcode-block" id="BarTender.get_menus_by_type"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.get_menus_by_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_menus_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns all :class:`Menu` instances of a given screen type.</span>

<span class="sd">        &#39;s&#39; for soluble screens and &#39;m&#39; for membrane screens. No other</span>
<span class="sd">        characters should be passed to `type_`.</span>

<span class="sd">        :param type_: Key for type of screen to return</span>
<span class="sd">        :type type_: str (max length 1)</span>
<span class="sd">        :return: list of menus of that screen type</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">menu</span> <span class="k">for</span> <span class="n">menu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">menu</span><span class="o">.</span><span class="n">type_</span> <span class="o">==</span> <span class="n">type_</span><span class="p">]</span></div>

<div class="viewcode-block" id="BarTender.get_menu_by_path"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.get_menu_by_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_menu_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a :class:`Menu` instance by its file path, which is</span>
<span class="sd">        used as the key for accessing the menus attribute normally.</span>

<span class="sd">        :param path: file path of a menu csv file</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :return: Menu instance that is mapped to given path</span>
<span class="sd">        :rtype: Menu</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">path</span><span class="p">]</span></div>

<div class="viewcode-block" id="BarTender.get_menu_by_basename"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.get_menu_by_basename">[docs]</a>    <span class="k">def</span> <span class="nf">get_menu_by_basename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Uses the basename of a :class:`Menu` file path to return a :class:`~Menu` object.</span>
<span class="sd">        Useful for retrieving menus based on the text of comboBoxes since</span>
<span class="sd">        when menus are displayed to the user only the basename is used.</span>

<span class="sd">        :param basename: Basename of a :class:`~polo.utils.io_utils.Menu` file path</span>
<span class="sd">        :type basename: str</span>
<span class="sd">        :return: Menu instance who&#39;s basename matches the `basename` argument,</span>
<span class="sd">                returns None is no menu is found</span>
<span class="sd">        :rtype: Menu or None</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">menu_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">:</span>  <span class="c1"># self.menus is dictionary</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">menu_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">basename</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">menu_key</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="CocktailMenuReader"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.CocktailMenuReader">[docs]</a><span class="k">class</span> <span class="nc">CocktailMenuReader</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;CocktailMenuReader instances should be used to read a csv file containing</span>
<span class="sd">    a collection of cocktail screens. The csv file should contain cocktail</span>
<span class="sd">    related formulations and assign each cocktail to a specific well in the</span>
<span class="sd">    screening plate. CocktailMenuReader is essentially a wrapper around </span>
<span class="sd">    the :class:`csv.DictReader` class. However it returns a :class:`Cocktail` instance </span>
<span class="sd">    instead of returning a dictionary via when it&#39;s __iter__ method is called.</span>

<span class="sd">    .. highlight:: python</span>
<span class="sd">    .. code-block:: python</span>

<span class="sd">        cocktail_menu = &#39;path/to/my/csv&#39;</span>
<span class="sd">        my_reader = CocktailMenuReader(cocktail_menu)</span>
<span class="sd">        csv_cocktails = my_reader.read_menu_file()</span>
<span class="sd">        # csv_cocktails now holds list of Cocktail objects read from</span>
<span class="sd">        # cocktail_menu</span>

<span class="sd">    :param menu_file: Path to cocktail menu file to read. Should be csv</span>
<span class="sd">                        formated</span>
<span class="sd">    :type menu_file: str or Path </span>
<span class="sd">    :param delim: Seperator for menu_file; really should not need to </span>
<span class="sd">                    be changed, defaults to &#39;,&#39;</span>
<span class="sd">    :type delim: str, optional</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">cocktail_map</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># map Cocktail attributes to index in menu rows</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;well_assignment&#39;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span>
        <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;pH&#39;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;commercial_code&#39;</span>
    <span class="p">}</span>
    <span class="n">formula_pos</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># each reagent could have a formula but only ever</span>
    <span class="c1"># one is included per cocktail entry</span>
    <span class="c1"># all other indicies are reagent names and concentrations</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">menu_file_path</span><span class="p">,</span> <span class="n">delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_file_path</span> <span class="o">=</span> <span class="n">menu_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delim</span> <span class="o">=</span> <span class="n">delim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_row_counter</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="CocktailMenuReader.set_cocktail_map"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.CocktailMenuReader.set_cocktail_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_cocktail_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">map</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Classmethod to edit the</span>
<span class="sd">        :attr:`~polo.utils.io_utils.CocktailMenuReader.cocktail_map`.</span>
<span class="sd">        The :attr:`~polo.utils.io_utils.CocktailMenuReader.cocktail_map`</span>
<span class="sd">        describes where the :class:`Cocktail` level information </span>
<span class="sd">        is stored in a given cocktail row in the csv file. </span>
<span class="sd">        It is a dictionary that maps specific indices in a row to</span>
<span class="sd">        :class:`Cocktail` attributes.</span>

<span class="sd">        The default cocktail_map dictionary is below.</span>

<span class="sd">        &gt;&gt;&gt; cocktail_map = {</span>
<span class="sd">        0: &#39;well_assignment&#39;,</span>
<span class="sd">        1: &#39;number&#39;,</span>
<span class="sd">        8: &#39;pH&#39;,</span>
<span class="sd">        2: &#39;commercial_code&#39;</span>
<span class="sd">        }</span>

<span class="sd">        This tells instances of CocktailMenuReader to look at index 0 of a row</span>
<span class="sd">        for the well_assignment attribute of the Cocktail class, index 1 for</span>
<span class="sd">        the number attribute of the Cocktail class, etc.</span>

<span class="sd">        :param map: Dictionary mapping csv row indicies to Cocktail object</span>
<span class="sd">                    attributes</span>
<span class="sd">        :type map: dict</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">cocktail_map</span> <span class="o">=</span> <span class="nb">map</span></div>

<div class="viewcode-block" id="CocktailMenuReader.set_formula_pos"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.CocktailMenuReader.set_formula_pos">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_formula_pos</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Classmethod to change the :attr:`CocktailMenuReader.formula_pos`</span>
<span class="sd">        attribute. The :attr:`~CocktailMenuReader.formula_pos`</span>
<span class="sd">        describes the location (base 0) of the chemical formula in a row of</span>
<span class="sd">        a cocktail menu file csv. For some reason, HWI cocktail menu files</span>
<span class="sd">        will only have one chemical formula per row (cocktail) no matter</span>
<span class="sd">        the number of reagents that composite that cocktail. This is why</span>
<span class="sd">        its location is represented using an int instead of a dict.</span>

<span class="sd">        Generally, :attr:`CocktailMenuReader.formula_pos`</span>
<span class="sd">        should not be changed without a very good</span>
<span class="sd">        reason as the position of the chemical formula is consistent across</span>
<span class="sd">        all HWI cocktail menu files.</span>

<span class="sd">        :param pos: Index where chemical formula can be found</span>
<span class="sd">        :type pos: int</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">formula_pos</span> <span class="o">=</span> <span class="n">pos</span></div>

<div class="viewcode-block" id="CocktailMenuReader.read_menu_file"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.CocktailMenuReader.read_menu_file">[docs]</a>    <span class="k">def</span> <span class="nf">read_menu_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Read the contents of cocktail menu csv file. The :class:`Menu` file path</span>
<span class="sd">        is read from the :attr:`Menu.menu_file_path` attribute. The first **two** lines</span>
<span class="sd">        of all the cocktail menu files included in Polo are header lines and</span>
<span class="sd">        so the reader will skip the first two lines before actually reading</span>
<span class="sd">        in any data. Each row is converted to a</span>
<span class="sd">        :class:`~polo.crystallography.cocktail.Cocktail` object and then</span>
<span class="sd">        added to a dictionary based on the  :class:`~polo.crystallography.cocktail.Cocktail`</span>
<span class="sd">        instance&#39;s well assignment.</span>

<span class="sd">        :return: Dictionary of Cocktail instances. Key value is the Cocktail&#39;s</span>
<span class="sd">                 well assignment in the screening plate (base 1).</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">cocktail_menu</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu_file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">menu_file</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">menu_file</span><span class="p">)</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>  <span class="c1"># skip first two rows</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cocktail_map</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_map</span><span class="p">}</span>
                <span class="n">new_cocktail</span> <span class="o">=</span> <span class="n">Cocktail</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
                <span class="n">new_cocktail</span><span class="o">.</span><span class="n">reagents</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># BUG: when new cocktail is intialized it contains the reagents</span>
                <span class="c1"># of all previously initialized cocktails. For now setting</span>
                <span class="c1"># new_cocktail.reagents to a new empty list fixes the</span>
                <span class="c1"># problem but does not address the source</span>
                <span class="n">reagent_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_map</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula_pos</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reagent_positions</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">chem_add</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">reagent_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                     <span class="n">row</span><span class="p">[</span><span class="n">reagent_positions</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">chem_add</span><span class="p">:</span>
                        <span class="n">con</span> <span class="o">=</span> <span class="n">UnitValue</span><span class="o">.</span><span class="n">make_from_string</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
                        <span class="n">new_cocktail</span><span class="o">.</span><span class="n">add_reagent</span><span class="p">(</span>
                            <span class="n">Reagent</span><span class="p">(</span>
                                <span class="n">chemical_additive</span><span class="o">=</span><span class="n">chem_add</span><span class="p">,</span>
                                <span class="n">concentration</span><span class="o">=</span><span class="n">con</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                <span class="n">cocktail_menu</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">new_cocktail</span><span class="o">.</span><span class="n">well_assignment</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_cocktail</span>
        <span class="k">return</span> <span class="n">cocktail_menu</span></div></div>


<div class="viewcode-block" id="RunLinker"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunLinker">[docs]</a><span class="k">class</span> <span class="nc">RunLinker</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Class to hold methods relating to linking runs either by</span>
<span class="sd">    date or by spectrum.</span>
<span class="sd">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="RunLinker.the_big_link"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunLinker.the_big_link">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">the_big_link</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Wrapper method to do all the linking required for a collection of</span>
<span class="sd">        runs. First calls :meth:`~polo.utils.io_utils.RunLinker.unlink_runs_completely`</span>
<span class="sd">        to separate any existing links so things do not get tangled. Then </span>
<span class="sd">        calls :meth:`~polo.utils.io_utils.RunLinker.link_runs_by_date` and</span>
<span class="sd">        :meth:`~polo.utils.io_utils.RunLinker.link_runs_by_spectrum`.</span>

<span class="sd">        :param runs: List of runs to link</span>
<span class="sd">        :type runs: list</span>
<span class="sd">        :return: List of runs with links made</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="n">RunLinker</span><span class="o">.</span><span class="n">unlink_runs_completely</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="n">RunLinker</span><span class="o">.</span><span class="n">link_runs_by_date</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>
        <span class="n">runs</span> <span class="o">=</span> <span class="n">RunLinker</span><span class="o">.</span><span class="n">link_runs_by_spectrum</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">runs</span></div>

<div class="viewcode-block" id="RunLinker.link_runs_by_date"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunLinker.link_runs_by_date">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">link_runs_by_date</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="c1"># need to seperate out the runs that can be linked and not</span>
        <span class="n">linkable_runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">runs</span> 
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;link_to_next_date&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">linkable_runs</span><span class="p">:</span>
            <span class="n">linkable_runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>  <span class="c1"># sort by date</span>
            <span class="n">runs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">image_spectrum</span> <span class="o">==</span> <span class="n">IMAGE_SPECS</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">linkable_runs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">linkable_runs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">linkable_runs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">link_to_next_date</span><span class="p">(</span><span class="n">linkable_runs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">linkable_runs</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">runs</span></div>

<div class="viewcode-block" id="RunLinker.link_runs_by_spectrum"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunLinker.link_runs_by_spectrum">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">link_runs_by_spectrum</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Link a collection of :class:`~polo.crystallography.run.HWIRun` instances</span>
<span class="sd">        together by spectrum. All non-visible</span>
<span class="sd">        :class:`~polo.crystallography.run.HWIRun` instances</span>
<span class="sd">        are linked together in a monodirectional circular linked list.</span>
<span class="sd">        Each visible :class:`~polo.crystallography.run.HWIRun` instance</span>
<span class="sd">        will then point to the same non-visible run through</span>
<span class="sd">        their :attr:`~polo.crystallography.run.HWIRun.alt_spectrum`</span>
<span class="sd">        attribute as a way to access the non-visible</span>
<span class="sd">        linked list.</span>

<span class="sd">        :param runs: List of runs to link together</span>
<span class="sd">        :type runs: list</span>
<span class="sd">        :return: List of runs linked by spectrum</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># for now this links all runs of the sample to the alt spectrums when</span>
        <span class="n">linkable_runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">runs</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;link_to_alt_spectrum&#39;</span><span class="p">)]</span>
        <span class="n">visible</span><span class="p">,</span> <span class="n">other</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">linkable_runs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">image_spectrum</span> <span class="o">==</span> <span class="n">IMAGE_SPECS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># visible images only</span>
                <span class="n">visible</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">other</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">image_spectrum</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">other</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">link_to_alt_spectrum</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">other</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">link_to_alt_spectrum</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">visible</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">visible</span><span class="p">:</span>
                    <span class="n">run</span><span class="o">.</span><span class="n">link_to_alt_spectrum</span><span class="p">(</span><span class="n">other</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># link to first run of alts</span>
        <span class="k">return</span> <span class="n">runs</span></div>

<div class="viewcode-block" id="RunLinker.unlink_runs_completely"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunLinker.unlink_runs_completely">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">unlink_runs_completely</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Cuts all links between the :class:`~polo.crystallography.run.HWIRun` instances</span>
<span class="sd">        passed through the `runs` argument and the</span>
<span class="sd">        :class:`~polo.crystallography.image.Image` instances</span>
<span class="sd">        in those runs.</span>

<span class="sd">        :param runs: List of runs</span>
<span class="sd">        :type runs: list</span>
<span class="sd">        :return: List of runs without any links</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">runs</span><span class="p">):</span>
            <span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">previous_run</span><span class="p">,</span> <span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">next_run</span><span class="p">,</span> <span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">alt_spectrum</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="n">image</span><span class="o">.</span><span class="n">next_image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">previous_image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">alt_image</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">runs</span></div></div>


<div class="viewcode-block" id="XmlReader"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XmlReader">[docs]</a><span class="k">class</span> <span class="nc">XmlReader</span><span class="p">():</span>

    <span class="n">platedef_key</span> <span class="o">=</span> <span class="s1">&#39;platedef&#39;</span>  <span class="c1"># keyword that is always in plate definition</span>
    <span class="c1"># xml file names</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xml_files</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;XmlReader class can be used to read the xml metadata files that are</span>
<span class="sd">        included in HWI screening run rar archives. Currently, is primarily meant</span>
<span class="sd">        to extract metadata about the plate and the sample in that plate.</span>

<span class="sd">        :param xml_path: File path to xml file</span>
<span class="sd">        :type xml_path: str or Path</span>
<span class="sd">        :param xml_files: list of xml file paths, defaults to []</span>
<span class="sd">        :type xml_files: list, optional</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml_path</span> <span class="o">=</span> <span class="n">xml_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml_files</span> <span class="o">=</span> <span class="n">xml_files</span>

<div class="viewcode-block" id="XmlReader.get_data_from_xml_element"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XmlReader.get_data_from_xml_element">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_data_from_xml_element</span><span class="p">(</span><span class="n">xml_element</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the data stored in an `xml_element`. Helper method</span>
<span class="sd">        for reading xml files.</span>

<span class="sd">        :param xml_element: xml element to read data from</span>
<span class="sd">        :type xml_element: [type]</span>
<span class="sd">        :return: Dictionary of data stored in xml element</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span><span class="p">:</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">xml_element</span>
                <span class="k">if</span> <span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="ow">and</span> <span class="n">elem</span><span class="o">.</span><span class="n">text</span><span class="p">}</span></div>

<div class="viewcode-block" id="XmlReader.read_plate_data_xml"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XmlReader.read_plate_data_xml">[docs]</a>    <span class="k">def</span> <span class="nf">read_plate_data_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Read the data stored in an xml document. HWI includes metadata</span>
<span class="sd">        about samples, imaging dates and other plate information in each</span>
<span class="sd">        rar archive that is distrubted. This method is used to read that</span>
<span class="sd">        data so it can be incorporated into :class:`HWIRun` objects.</span>

<span class="sd">        :param xml_path: Path to xml file to read, defaults to None.</span>
<span class="sd">                         If None uses the xml path stored in `xml_path` attribute.</span>
<span class="sd">        :type xml_path: str or Path, optional</span>
<span class="sd">        :return: Dictionary of xml data if read was successful, Exception otherwise</span>
<span class="sd">        :rtype: dict or Exception</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">xml_path</span><span class="p">:</span>
            <span class="n">xml_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_file</span>
        <span class="n">xml_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

            <span class="n">d</span> <span class="o">=</span> <span class="n">XmlReader</span><span class="o">.</span><span class="n">get_data_from_xml_element</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">XmlReader</span><span class="o">.</span><span class="n">get_data_from_xml_element</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">d</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">IsADirectoryError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_plate_data_xml</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="XmlReader.discover_xml_files"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XmlReader.discover_xml_files">[docs]</a>    <span class="k">def</span> <span class="nf">discover_xml_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Look for xml files in a given directory.</span>

<span class="sd">        :param parent_dir: Directory to look for xml files in</span>
<span class="sd">        :type parent_dir: str or Path</span>
<span class="sd">        :return: List of xml file paths, if any exist</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                          <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">))]</span>
            <span class="n">xmls</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_paths</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;.xml&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">xmls</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">PermissionError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> while calling </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">discover_xml_files</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="XmlReader.find_and_read_plate_data"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XmlReader.find_and_read_plate_data">[docs]</a>    <span class="k">def</span> <span class="nf">find_and_read_plate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Find xml metadata files in a given directory. Read the</span>
<span class="sd">        data from xml files that contain the :const:`plate_def` key</span>
<span class="sd">        string.</span>

<span class="sd">        :param parent_dir: Directory to look for xml files</span>
<span class="sd">        :type parent_dir: Path or str</span>
<span class="sd">        :return: Dict if xml file found and read successfully, False otherwise</span>
<span class="sd">        :rtype: dict or bool</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">xml_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">discover_xml_files</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xml_files</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">xml_file</span> <span class="ow">in</span> <span class="n">xml_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">platedef_key</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">xml_file</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_plate_data_xml</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="Menu"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.Menu">[docs]</a><span class="k">class</span> <span class="nc">Menu</span><span class="p">():</span>  <span class="c1"># holds the dictionary of cocktails</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">type_</span><span class="p">,</span> <span class="n">cocktails</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&#39;&#39;&#39;Creates a :class:`Menu` instance. :class:`Menu` objects are used to organize a single</span>
<span class="sd">        screening run plate set up. They should contain 1536 unique screening</span>
<span class="sd">        conditions; one for each well in the HWI high-throughput plate. HWI</span>
<span class="sd">        has altered what cocktails are used in each of the 1536 wells over the</span>
<span class="sd">        years and so many versions of cocktail menus have been used. A single</span>
<span class="sd">        :class:`Menu` instance represents one of these versions and accordingly has a</span>
<span class="sd">        start and end date to identify when the menu was used. Additionally, </span>
<span class="sd">        HWI offers two types of high throughput screens; membrane or soluble</span>
<span class="sd">        screens. Both use 1536 well plates but have very different chemical</span>
<span class="sd">        conditions at the same well index. </span>

<span class="sd">        :class:`Menu`s that hold conditions for soluble screens are the `type_`</span>
<span class="sd">        attribute set to &#39;s&#39; and menus that hold conditions for membrane</span>
<span class="sd">        screens have the `type_` attribute set to &#39;m&#39;.</span>

<span class="sd">        :param path: Location of the menu csv file</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :param start_date: Date when this screen menu was first used</span>
<span class="sd">        :type start_date: datetime</span>
<span class="sd">        :param end_date: Last date this screen menu was used</span>
<span class="sd">        :type end_date: datetime</span>
<span class="sd">        :param type_: Membrane or soluble screen</span>
<span class="sd">        :type type_: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type_</span> <span class="o">=</span> <span class="n">type_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cocktails</span> <span class="o">=</span> <span class="n">cocktails</span>  <span class="c1"># holds all cocktails (items on the menu)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cocktails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cocktails</span>

    <span class="nd">@cocktails</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cocktails</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_cocktails</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">new_cocktails</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cocktails</span> <span class="o">=</span> <span class="n">new_cocktails</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cocktails</span> <span class="o">=</span> <span class="n">CocktailMenuReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">read_menu_file</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cocktails</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cocktails</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cocktails</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>
    



    <span class="c1"># or potentially use a file browser to do this one and put it in a wdiget</span>


<span class="c1"># orphan functions that have not made it into a class yet</span>
<span class="c1"># =============================================================================</span>


<div class="viewcode-block" id="write_screen_html"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.write_screen_html">[docs]</a><span class="k">def</span> <span class="nf">write_screen_html</span><span class="p">(</span><span class="n">plate_list</span><span class="p">,</span> <span class="n">well_number</span><span class="p">,</span> <span class="n">run_name</span><span class="p">,</span> <span class="n">x_reagent</span><span class="p">,</span>
                      <span class="n">y_reagent</span><span class="p">,</span> <span class="n">well_volume</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>

    <span class="n">template</span> <span class="o">=</span> <span class="n">SCREEN_HTML_TEMPLATE</span>
    <span class="n">template_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">SCREEN_HTML_TEMPLATE</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">template_string</span><span class="p">)</span>

    <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">plate_list</span><span class="o">=</span><span class="n">plate_list</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">,</span>
                           <span class="n">well_number</span><span class="o">=</span><span class="n">well_number</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                           <span class="n">x_reagent_stock</span><span class="o">=</span><span class="n">x_reagent</span><span class="p">,</span>
                           <span class="n">y_reagent_stock</span><span class="o">=</span><span class="n">y_reagent</span><span class="p">,</span>
                           <span class="n">well_volume</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">well_volume</span><span class="p">))</span>

    <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s1">&#39;.html&#39;</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.html&#39;</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">screen_html</span><span class="p">:</span>
        <span class="n">screen_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_HWI_filename_meta"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.parse_HWI_filename_meta">[docs]</a><span class="k">def</span> <span class="nf">parse_HWI_filename_meta</span><span class="p">(</span><span class="n">HWI_image_file</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    HWI images have a standard file nameing schema that gives info about when</span>
<span class="sd">    they are taken and well number and that kind of thing. This function returns</span>
<span class="sd">    that data</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">HWI_image_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">HWI_image_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">HWI_image_file</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">HWI_image_file</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)),</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">HWI_image_file</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">],</span> <span class="s1">&#39;%Y&#39;&#39;%m&#39;&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
        <span class="n">HWI_image_file</span><span class="p">[</span><span class="mi">22</span><span class="p">:]</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="list_dir_abs"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.list_dir_abs">[docs]</a><span class="k">def</span> <span class="nf">list_dir_abs</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">files</span><span class="p">,</span> <span class="n">allowed_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">),</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">abs_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">ALLOWED_IMAGE_TYPES</span><span class="p">:</span>
                <span class="n">allowed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">abs_file_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allowed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">abs_file_path</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">allowed_files</span></div>


<div class="viewcode-block" id="parse_hwi_dir_metadata"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.parse_hwi_dir_metadata">[docs]</a><span class="k">def</span> <span class="nf">parse_hwi_dir_metadata</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
        <span class="n">image_type</span> <span class="o">=</span> <span class="n">dir_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plate_id</span> <span class="o">=</span> <span class="n">dir_name</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dir_name</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="s1">&#39;%Y&#39;&#39;%m&#39;&#39;</span><span class="si">%d</span><span class="s1">&#39;&#39;%H&#39;&#39;%M&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image_type</span><span class="p">,</span> <span class="n">plate_id</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">dir_name</span>  <span class="c1"># last is suggeseted run name</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1"> attempting to parse </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">parse_hwi_dir_metadata</span><span class="p">,</span> <span class="n">dir_name</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">e</span></div>


<div class="viewcode-block" id="directory_validator"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.directory_validator">[docs]</a><span class="k">def</span> <span class="nf">directory_validator</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">list_dir_abs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">ForbiddenImageTypeError</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory validation failed with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="ne">NotADirectoryError</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory validation failed with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="ne">FileNotFoundError</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory validation failed with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="ne">FileNotFoundError</span></div>


<div class="viewcode-block" id="check_for_missing_images"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.check_for_missing_images">[docs]</a><span class="k">def</span> <span class="nf">check_for_missing_images</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">expected_image_count</span><span class="p">):</span>
    <span class="n">number_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_dir_abs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">number_images</span> <span class="o">!=</span> <span class="n">expected_image_count</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="run_name_validator"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.run_name_validator">[docs]</a><span class="k">def</span> <span class="nf">run_name_validator</span><span class="p">(</span><span class="n">new_run_name</span><span class="p">,</span> <span class="n">current_run_names</span><span class="p">):</span>
    <span class="c1"># checks that new run name is utf 8 and</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_run_name</span> <span class="o">=</span> <span class="n">new_run_name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">new_run_name</span> <span class="o">=</span> <span class="n">new_run_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> failed run name validation with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">new_run_name</span><span class="p">,</span> <span class="n">e</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">new_run_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">new_run_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="ne">TypeError</span>
    <span class="k">if</span> <span class="n">new_run_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_run_names</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="if_dir_not_exists_make"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.if_dir_not_exists_make">[docs]</a><span class="k">def</span> <span class="nf">if_dir_not_exists_make</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">child_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;If only parent_dir is given attempts to make that directory. If parent</span>
<span class="sd">    and child are given tries to make a directory child_dir within parent dir.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">child_dir</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">child_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">parent_dir</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not make directory with path </span><span class="si">{}</span><span class="s1">. Returned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">e</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="k">return</span> <span class="n">path</span></div>

<span class="kn">from</span> <span class="nn">polo.crystallography.image</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">polo.crystallography.run</span> <span class="kn">import</span> <span class="o">*</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Ethan Holleman

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
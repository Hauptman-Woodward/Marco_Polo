

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>polo.utils.io_utils &mdash; Polo 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Polo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Quickstart.html">Polo Quickstart Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQS.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide.html">Userâ€™s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../beta_testers.html">Beta Testers Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../polo.html">polo package</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Polo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../polo.html">polo</a> &raquo;</li>
        
      <li>polo.utils.io_utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for polo.utils.io_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">dateutil.parser</span> <span class="kn">import</span> <span class="n">parse</span>
<span class="kn">from</span> <span class="nn">PyQt5</span> <span class="kn">import</span> <span class="n">QtWidgets</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtCore</span> <span class="kn">import</span> <span class="n">Qt</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtGui</span> <span class="kn">import</span> <span class="n">QBrush</span><span class="p">,</span> <span class="n">QColor</span><span class="p">,</span> <span class="n">QIcon</span><span class="p">,</span> <span class="n">QPixmap</span>
<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QAction</span><span class="p">,</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QGridLayout</span>

<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">polo</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ALLOWED_IMAGE_TYPES</span><span class="p">,</span> <span class="n">COCKTAIL_DATA_PATH</span><span class="p">,</span> <span class="n">COCKTAIL_META_DATA</span><span class="p">,</span>
                  <span class="n">RUN_HTML_TEMPLATE</span><span class="p">,</span> <span class="n">SCREEN_HTML_TEMPLATE</span><span class="p">,</span> <span class="n">__version__</span><span class="p">,</span>
                  <span class="n">make_default_logger</span><span class="p">,</span> <span class="n">num_regex</span><span class="p">,</span> <span class="n">unit_regex</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">polo.crystallography.cocktail</span> <span class="kn">import</span> <span class="n">Cocktail</span><span class="p">,</span> <span class="n">Reagent</span><span class="p">,</span> <span class="n">SignedValue</span>
<span class="kn">from</span> <span class="nn">polo.threads.thread</span> <span class="kn">import</span> <span class="n">QuickThread</span>
<span class="kn">from</span> <span class="nn">polo.utils.exceptions</span> <span class="kn">import</span> <span class="n">EmptyRunNameError</span><span class="p">,</span> <span class="n">ForbiddenImageTypeError</span>
<span class="kn">from</span> <span class="nn">polo.utils.math_utils</span> <span class="kn">import</span> <span class="n">best_aspect_ratio</span><span class="p">,</span> <span class="n">get_cell_image_dims</span>
<span class="kn">from</span> <span class="nn">polo.crystallography.image</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">make_default_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="RunSerializer"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunSerializer">[docs]</a><span class="k">class</span> <span class="nc">RunSerializer</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span> <span class="o">=</span> <span class="n">run</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Made RunSerializer </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

<div class="viewcode-block" id="RunSerializer.make_thread"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunSerializer.make_thread">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_thread</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">job_function</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates a new qthread object. The job function is the</span>
<span class="sd">        function the thread will execute and and arguments that the job</span>
<span class="sd">        function requires should be passed has keyword arguments. These are</span>
<span class="sd">        stored as a dictionary in the new thread object until the thread is</span>
<span class="sd">        activated and they are passed as arguments.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">QuickThread</span><span class="p">(</span><span class="n">job_function</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunSerializer.path_suffix_checker"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunSerializer.path_suffix_checker">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">path_suffix_checker</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">desired_suffix</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check is a file path has a desired suffix, if not then replace the</span>
<span class="sd">        current suffix with the desired suffix. Useful for checking filenames</span>
<span class="sd">        that are taken from user input.</span>

<span class="sd">        :param desired_suffix: File extension for given file path.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="n">desired_suffix</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">desired_suffix</span><span class="p">))</span></div>

<div class="viewcode-block" id="RunSerializer.make_message_box"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunSerializer.make_message_box">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_message_box</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Information</span><span class="p">,</span>
                         <span class="n">buttons</span><span class="o">=</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Ok</span><span class="p">,</span>
                         <span class="n">connected_function</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a QMessageBox instance to show to the user.</span>

<span class="sd">        :param message: Message to be displayed to the user</span>
<span class="sd">        :type message: str</span>
<span class="sd">        :param icon: Icon for message box, defaults to QtWidgets.QMessageBox.Information</span>
<span class="sd">        :type icon: QMessageBoxIcon, optional</span>
<span class="sd">        :param buttons: [description], defaults to QtWidgets.QMessageBox.Ok</span>
<span class="sd">        :type buttons: [type], optional</span>
<span class="sd">        :param connected_function: [description], defaults to None</span>
<span class="sd">        :type connected_function: [type], optional</span>
<span class="sd">        :return: [description]</span>
<span class="sd">        :rtype: [type]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QMessageBox</span><span class="p">()</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">icon</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">connected_function</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">connected_function</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Made message box with message &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="RunSerializer.path_validator"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunSerializer.path_validator">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">path_validator</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Tests to ensure a path exists. Passing parent = True will check for</span>
<span class="sd">        the existance of the parent directory of the path.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">.unitsn&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="HtmlWriter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter">[docs]</a><span class="k">class</span> <span class="nc">HtmlWriter</span><span class="p">(</span><span class="n">RunSerializer</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HtmlWriter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="HtmlWriter.make_template"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter.make_template">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_template</span><span class="p">(</span><span class="n">template_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a path to an html file to serve as a jinja2 template, read the</span>
<span class="sd">        file and create a new template object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">template</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Template</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span></div>

<div class="viewcode-block" id="HtmlWriter.write_complete_run_on_thread"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter.write_complete_run_on_thread">[docs]</a>    <span class="k">def</span> <span class="nf">write_complete_run_on_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">encode_images</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wrapper around `write_complete_run` that executes on a seperate</span>
<span class="sd">        Qthread.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">make_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_complete_run</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">,</span>
            <span class="n">encode_images</span><span class="o">=</span><span class="n">encode_images</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished_writing</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">{}</span><span class="s1"> as html to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_complete_run</span><span class="p">,</span> <span class="n">output_path</span><span class="p">))</span></div>

<div class="viewcode-block" id="HtmlWriter.finished_writing"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter.finished_writing">[docs]</a>    <span class="k">def</span> <span class="nf">finished_writing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># should only be called from connection to thread</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Method to connect to Qthread instance. Should not be called from</span>
<span class="sd">        anything other than a Qthread instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Export to </span><span class="si">{}</span><span class="s1"> was successful&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Export to HTML file failed. Returned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Html write attempt status: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">make_message_box</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span></div>

<div class="viewcode-block" id="HtmlWriter.write_complete_run"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter.write_complete_run">[docs]</a>    <span class="k">def</span> <span class="nf">write_complete_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">encode_images</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># write a run as html file with images and classifications</span>
        <span class="c1"># and that kind of stuff</span>
        <span class="k">if</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">path_validator</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">:</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">encode_images</span><span class="p">:</span>
                <span class="n">run</span><span class="o">.</span><span class="n">encode_images_to_base64</span><span class="p">()</span>
            <span class="n">images</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">XtalWriter</span><span class="o">.</span><span class="n">json_encoder</span><span class="p">))</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">make_template</span><span class="p">(</span><span class="n">RUN_HTML_TEMPLATE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">template</span><span class="p">:</span>
                <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                    <span class="n">images</span><span class="o">=</span><span class="n">images</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run_name</span><span class="p">,</span>
                    <span class="n">annotations</span><span class="o">=</span><span class="s1">&#39;No annotations&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">html_file</span><span class="p">:</span>
                    <span class="n">html_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">output_path</span></div>

<div class="viewcode-block" id="HtmlWriter.write_grid_screen"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.HtmlWriter.write_grid_screen">[docs]</a>    <span class="k">def</span> <span class="nf">write_grid_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">,</span> <span class="n">plate_list</span><span class="p">,</span> <span class="n">well_number</span><span class="p">,</span>
                          <span class="n">x_reagent</span><span class="p">,</span> <span class="n">y_reagent</span><span class="p">,</span> <span class="n">well_volume</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Write the contents of optimization grid screen to an html file</span>

<span class="sd">        :param output_path: Path to html file</span>
<span class="sd">        :type output_path: str</span>
<span class="sd">        :param plate_list: list containing grid screen data</span>
<span class="sd">        :type plate_list: list</span>
<span class="sd">        :param well_number: well number of hit screen is created from</span>
<span class="sd">        :type well_number: int or str</span>
<span class="sd">        :param x_reagent: reagent varried in x direction</span>
<span class="sd">        :type x_reagent: Reagent</span>
<span class="sd">        :param y_reagent: reagent varried in y direction</span>
<span class="sd">        :type y_reagent: Reagent</span>
<span class="sd">        :param well_volume: Volume of well used in screen</span>
<span class="sd">        :type well_volume: int or str</span>
<span class="sd">        :param run_name: name of run, defaults to None</span>
<span class="sd">        :type run_name: str, optional</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">path_validator</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">output_path</span> <span class="o">=</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span><span class="n">ouput_path</span><span class="p">,</span> <span class="s1">&#39;.html&#39;</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">HtmlWriter</span><span class="o">.</span><span class="n">make_template</span><span class="p">(</span><span class="n">SCREEN_HTML_TEMPLATE</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">run_name</span><span class="p">:</span>
                <span class="n">run_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run_name</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">plate_list</span><span class="o">=</span><span class="n">plate_list</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">,</span>
                                   <span class="n">well_number</span><span class="o">=</span><span class="n">well_number</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                                   <span class="n">x_reagent_stock</span><span class="o">=</span><span class="n">x_reagent</span><span class="p">,</span>
                                   <span class="n">y_reagent_stock</span><span class="o">=</span><span class="n">y_reagent</span><span class="p">,</span>
                                   <span class="n">well_volume</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">well_volume</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">screen_html</span><span class="p">:</span>
                <span class="n">screen_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RunCsvWriter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunCsvWriter">[docs]</a><span class="k">class</span> <span class="nc">RunCsvWriter</span><span class="p">(</span><span class="n">RunSerializer</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_path</span> <span class="o">=</span> <span class="n">output_path</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RunCsvWriter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__output_path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fieldnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># could use more efficent way of determining feildnames</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
        <span class="n">fieldnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">fieldnames</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">fieldnames</span>


    <span class="nd">@output_path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">output_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="n">new_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__output_path</span> <span class="o">=</span> <span class="n">new_path</span>

<div class="viewcode-block" id="RunCsvWriter.image_to_row"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunCsvWriter.image_to_row">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">image_to_row</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">image</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Cocktail</span><span class="p">):</span>
                <span class="n">row</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">number</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Image</span><span class="p">):</span>
                <span class="n">row</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">path</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># unwrap the dict</span>
                <span class="k">for</span> <span class="n">attr_b</span><span class="p">,</span> <span class="n">value_b</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">attr_b</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>  <span class="c1"># only add if will not override higher level attr</span>
                        <span class="c1"># only go one level deep for now</span>
                        <span class="n">row</span><span class="p">[</span><span class="n">attr_b</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value_b</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">continue</span>  <span class="c1"># currently do not encode bytes (base 64 stuff)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># default to case to string</span>
        <span class="k">return</span> <span class="n">row</span></div>
    
<div class="viewcode-block" id="RunCsvWriter.get_csv_data"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunCsvWriter.get_csv_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_csv_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">fieldnames</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">return</span> <span class="n">fieldnames</span><span class="p">,</span> <span class="n">rows</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>  <span class="c1"># pass it along will ya </span></div>

<div class="viewcode-block" id="RunCsvWriter.write_csv"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunCsvWriter.write_csv">[docs]</a>    <span class="k">def</span> <span class="nf">write_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="n">fieldnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">fieldnames</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csv_path</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">fieldnames</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Caught exception </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_csv</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">RunCsvWriter</span><span class="o">.</span><span class="n">image_to_row</span><span class="p">(</span><span class="n">image</span><span class="p">)</span></div>


<div class="viewcode-block" id="XtalWriter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter">[docs]</a><span class="k">class</span> <span class="nc">XtalWriter</span><span class="p">(</span><span class="n">RunSerializer</span><span class="p">):</span>
    <span class="n">header_flag</span> <span class="o">=</span> <span class="s1">&#39;&lt;&gt;&#39;</span>  <span class="c1"># do not change unless very good reason</span>
    <span class="n">header_line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">:</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">file_ext</span> <span class="o">=</span> <span class="s1">&#39;.xtal&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">XtalWriter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xtal_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates the header for xtal file when called. Header lines are</span>
<span class="sd">        indicated as such by the string in the header_line constant,</span>
<span class="sd">        which should be &#39;&lt;&gt;&#39;. The last line of the header will be a row</span>
<span class="sd">        of equal signs and then the actual json content begins on the</span>
<span class="sd">        next line.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">header</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header_flag</span><span class="p">,</span> <span class="s1">&#39;SAVE TIME&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">header</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">header_flag</span><span class="p">,</span> <span class="s1">&#39;VERSION&#39;</span><span class="p">,</span> <span class="n">__version__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">header_flag</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">header</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">79</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1"># add ==== as a break between json data and header data</span>

<div class="viewcode-block" id="XtalWriter.json_encoder"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.json_encoder">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">json_encoder</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Use instead of the defauly json encoder. If the encoded object</span>
<span class="sd">        is from a module within Polo will include a module and class</span>
<span class="sd">        identifier so it can be more easily deserialized when loaded</span>
<span class="sd">        back into the program.</span>

<span class="sd">        :param: obj: An object to serialize to json.</span>

<span class="sd">        :returns: A dictionary or string version of passed object</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">):</span>  <span class="c1"># can send to dict object</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;__class__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;__module__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__module__</span>
            <span class="c1"># store module and class name along with object as dict</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># not castable to dict</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>  <span class="c1"># likely the base64 encoded image</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># if all else fails case to string</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="XtalWriter.write_xtal_file_on_thread"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.write_xtal_file_on_thread">[docs]</a>    <span class="k">def</span> <span class="nf">write_xtal_file_on_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrapper method around `write_xtal_file` that executes on a Qthread</span>
<span class="sd">        instance to prevent freezing the GUI when saving large xtal files</span>

<span class="sd">        :param output_path: Path to xtal file</span>
<span class="sd">        :type output_path: str</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">make_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_xtal_file</span><span class="p">,</span> <span class="n">output_path</span><span class="o">=</span><span class="n">output_path</span><span class="p">)</span>
        <span class="c1"># connect to something when thread finishes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished_save</span><span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">setOverrideCursor</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">WaitCursor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="XtalWriter.finished_save"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.finished_save">[docs]</a>    <span class="k">def</span> <span class="nf">finished_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">restoreOverrideCursor</span><span class="p">()</span>  <span class="c1"># return cursor to normal</span>
        <span class="c1"># should contain path to now saved file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">result</span><span class="p">)):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Saved current run to </span><span class="si">{}</span><span class="s1">!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Save to failed. Returned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>

        <span class="n">XtalWriter</span><span class="o">.</span><span class="n">make_message_box</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span></div>

<div class="viewcode-block" id="XtalWriter.write_xtal_file"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.write_xtal_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_xtal_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Method to serialize run object to xtal file format.</span>

<span class="sd">        :param output_path: Xtal file path</span>
<span class="sd">        :type output_path: str</span>
<span class="sd">        :return: path to xtal file</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">path_validator</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="c1"># path is good to go and ready to write file into</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">encode_images_to_base64</span><span class="p">()</span>
            <span class="n">run_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># encoding worked, no errors caught</span>
                <span class="n">output_path</span> <span class="o">=</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">path_suffix_checker</span><span class="p">(</span>
                    <span class="n">output_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_ext</span><span class="p">)</span>  <span class="c1"># make sure has .xtal suffix</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xtal_file</span><span class="p">:</span>
                        <span class="n">xtal_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtal_header</span><span class="p">)</span>
                        <span class="n">xtal_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">run_str</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">output_path</span>
                <span class="k">except</span> <span class="ne">PermissionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_xtal_file</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">e</span></div>

<div class="viewcode-block" id="XtalWriter.clean_run_for_save"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.clean_run_for_save">[docs]</a>    <span class="k">def</span> <span class="nf">clean_run_for_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove circular references from a Run instance to avoid errors</span>
<span class="sd">        when serializing using json. Uses the run stored in the run attribute</span>

<span class="sd">        :return: The cleaned run</span>
<span class="sd">        :rtype: Run</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># removes references to other runs so not to throw a</span>
        <span class="c1"># json encoding error</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">previous_run</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">next_run</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">alt_spectrum</span> <span class="o">=</span> <span class="p">(</span>
                <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
                    <span class="n">image</span><span class="o">.</span><span class="n">previous_image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">next_image</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">alt_image</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span></div>

<div class="viewcode-block" id="XtalWriter.run_to_dict"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.XtalWriter.run_to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">run_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a json string from the run stored in the run attribute.</span>

<span class="sd">        :return: Run instance serialized to json</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clean_run_for_save</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">encode_images_to_base64</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="n">XtalWriter</span><span class="o">.</span><span class="n">json_encoder</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">FileNotFoundError</span><span class="p">,</span>
                    <span class="ne">IsADirectoryError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to encode </span><span class="si">{}</span><span class="s1"> to dict. Gave </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="RunDeserializer"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer">[docs]</a><span class="k">class</span> <span class="nc">RunDeserializer</span><span class="p">():</span>  <span class="c1"># convert saved file into a run</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtal_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xtal_path</span> <span class="o">=</span> <span class="n">xtal_path</span>

<div class="viewcode-block" id="RunDeserializer.clean_base64_string"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.clean_base64_string">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean_base64_string</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Image instances may contain byte strings that store their actual</span>
<span class="sd">        crystallization image encoded as base64. Previously, these byte strings</span>
<span class="sd">        were written directly into the json file as strings causing the b&#39;</span>
<span class="sd">        byte string identifier to be written along with the actual base64 data.</span>
<span class="sd">        This method removes those artifacts if they are present and returns a</span>
<span class="sd">        clean byte string with only the actual base64 data.</span>

<span class="sd">        :param string: a string to interogate</span>
<span class="sd">        :type string: str</span>
<span class="sd">        :return: byte string with non-data artifacts removed</span>
<span class="sd">        :rtype: bytes</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">string</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>  <span class="c1"># bytes string written directly to string</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">string</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
                <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunDeserializer.dict_to_obj"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.dict_to_obj">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dict_to_obj</span><span class="p">(</span><span class="n">our_dict</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Oposite of the obj_to_dict method in XtalWriter class, this method</span>
<span class="sd">        takes a dictionary instance that has been previously serialized and</span>
<span class="sd">        attempts to convert it back into an object instance.</span>

<span class="sd">        :param our_dict: dictionary to convert back to object</span>
<span class="sd">        :type our_dict: dict</span>
<span class="sd">        :return: an object</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">our_dict</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;__class__&quot;</span> <span class="ow">in</span> <span class="n">our_dict</span><span class="p">:</span>
                    <span class="n">class_name</span> <span class="o">=</span> <span class="n">our_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__class__&quot;</span><span class="p">)</span>
                    <span class="n">module_name</span> <span class="o">=</span> <span class="n">our_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__module__&quot;</span><span class="p">)</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                    <span class="n">class_</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
                    <span class="n">our_dict_two</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">our_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="s1">&#39;__&#39;</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="s1">&#39;_&#39;</span> <span class="o">==</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">our_dict_two</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">class_</span><span class="p">(</span><span class="o">**</span><span class="n">our_dict_two</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">our_dict</span>
                <span class="k">return</span> <span class="n">obj</span>
            <span class="k">except</span> <span class="ne">NotADirectoryError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> attempting to create object&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Attempted to serialize an empty dictionary at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dict_to_obj</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="RunDeserializer.xtal_header_reader"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.xtal_header_reader">[docs]</a>    <span class="k">def</span> <span class="nf">xtal_header_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xtal_file_io</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Reads the header section of an open xtal file. Should always be</span>
<span class="sd">        called before reading the json content of an xtal file. Note than</span>
<span class="sd">        xtal files must always have a line of equal signs before the json</span>
<span class="sd">        content even if there is no header content otherwise this method will</span>
<span class="sd">        read one line into the json content causing the json reader to</span>
<span class="sd">        throw an error.</span>

<span class="sd">        :param xtal_file_io: xtal file currently being read</span>
<span class="sd">        :type xtal_file_io: TextIoWrapper</span>
<span class="sd">        :return: xtal header contents</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># pulls info in the header of an xtal file</span>
        <span class="n">header_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">xtal_file_io</span><span class="o">.</span><span class="n">readline</span><span class="p">()]</span>
        <span class="k">while</span> <span class="n">header_data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">XtalWriter</span><span class="o">.</span><span class="n">header_flag</span><span class="p">)]</span> <span class="o">==</span> <span class="n">XtalWriter</span><span class="o">.</span><span class="n">header_flag</span><span class="p">:</span>
            <span class="n">header_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xtal_file_io</span><span class="o">.</span><span class="n">readline</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">header_data</span></div>

<div class="viewcode-block" id="RunDeserializer.xtal_to_run"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.RunDeserializer.xtal_to_run">[docs]</a>    <span class="k">def</span> <span class="nf">xtal_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Method that actually does the heavy lifting of converting the json</span>
<span class="sd">        contents of xtal files back into Run instances. Currently is pretty</span>
<span class="sd">        brittle and ugly so looking for a more flexible recursive solution.</span>

<span class="sd">        :raises e: Error raised while reading the xtal file</span>
<span class="sd">        :return: The contents of xtal file as a Run instance</span>
<span class="sd">        :rtype: Run</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Attempting to load run from </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtal_path</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtal_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtal_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">xtal_data</span><span class="p">:</span>
                    <span class="n">header_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xtal_header_reader</span><span class="p">(</span>
                        <span class="n">xtal_data</span><span class="p">)</span>  <span class="c1"># must read header first</span>
                    <span class="n">j_d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">xtal_data</span><span class="p">)</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">RunDeserializer</span><span class="o">.</span><span class="n">dict_to_obj</span><span class="p">(</span><span class="n">j_d</span><span class="p">)</span>

                <span class="n">run</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                    <span class="n">run</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">):</span>
                    <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">RunDeserializer</span><span class="o">.</span><span class="n">dict_to_obj</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bites</span> <span class="o">=</span> <span class="n">RunDeserializer</span><span class="o">.</span><span class="n">clean_base64_string</span><span class="p">(</span>
                        <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">bites</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                            <span class="n">date</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">date</span>
                            <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                                <span class="n">date</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                        <span class="n">reagents</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cocktail</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cocktail</span><span class="p">[</span><span class="s1">&#39;reagents&#39;</span><span class="p">]):</span>
                                <span class="c1"># holy mother of jank</span>
                                <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cocktail</span><span class="p">[</span><span class="s1">&#39;reagents&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;_Reagent__concentration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RunDeserializer</span><span class="o">.</span><span class="n">dict_to_obj</span><span class="p">(</span>
                                    <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cocktail</span><span class="p">[</span><span class="s1">&#39;reagents&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;_Reagent__concentration&#39;</span><span class="p">])</span>
                                <span class="n">reagents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RunDeserializer</span><span class="o">.</span><span class="n">dict_to_obj</span><span class="p">(</span>
                                    <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cocktail</span><span class="p">[</span><span class="s1">&#39;reagents&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]))</span>
                                <span class="c1"># reagents[-1].concentration = RunDeserializer.dict_to_obj(</span>
                                <span class="c1">#     reagents[j].concentration)</span>
                            <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cocktail</span> <span class="o">=</span> <span class="n">RunDeserializer</span><span class="o">.</span><span class="n">dict_to_obj</span><span class="p">(</span>
                                <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cocktail</span><span class="p">)</span>
                            <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cocktail</span><span class="o">.</span><span class="n">reagents</span> <span class="o">=</span> <span class="n">reagents</span>
                <span class="k">return</span> <span class="n">run</span>  <span class="c1"># TODO Interpret the header data</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">IsADirectoryError</span><span class="p">,</span> <span class="ne">PermissionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed to read </span><span class="si">{}</span><span class="s1"> into run object at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xtal_path</span><span class="p">,</span> <span class="s1">&#39;Place Holder&#39;</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span></div></div>


<div class="viewcode-block" id="BarTender"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender">[docs]</a><span class="k">class</span> <span class="nc">BarTender</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Class for organizing and accessing cocktail menus&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cocktail_dir</span><span class="p">,</span> <span class="n">cocktail_meta</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create instance of BarTender object. Probably only going to need</span>
<span class="sd">        to make one instance since the bartender should organize all</span>
<span class="sd">        available cocktail menus for the current Polo session. Currently,</span>
<span class="sd">        the BarTender instance that is used everywhere is declared in polo</span>
<span class="sd">        __init__ file.</span>

<span class="sd">        :param cocktail_dir: Path to directory holding cocktail menu files</span>
<span class="sd">        :type cocktail_dir: str</span>
<span class="sd">        :param cocktail_meta: Path to csv file containing cocktail menu metadata.units</span>
<span class="sd">        which includes things like when each menu was used, what kind.units</span>
<span class="sd">        of screens it was used for, etc.</span>
<span class="sd">        :type cocktail_meta: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_dir</span> <span class="o">=</span> <span class="n">cocktail_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_meta</span> <span class="o">=</span> <span class="n">cocktail_meta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menus</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_menus_from_metadata</span><span class="p">()</span>

<div class="viewcode-block" id="BarTender.datetime_converter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.datetime_converter">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">datetime_converter</span><span class="p">(</span><span class="n">date_string</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;General utility function for converting strings to datetime objects..units</span>
<span class="sd">            Attempts to convert the string by trying a couple of datetime.units</span>
<span class="sd">            formats that are common in cocktail menu files and other.units</span>
<span class="sd">            locations in the HWI file universe Polo runs across.</span>

<span class="sd">        :param date_string: string to convert to datetime</span>
<span class="sd">        :type date_string: str</span>
<span class="sd">        :return: datetime object</span>
<span class="sd">        :rtype: datetime</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">date_string</span> <span class="o">=</span> <span class="n">date_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">datetime_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">,</span> <span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%y&#39;</span><span class="p">,</span> <span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">-%Y&#39;</span><span class="p">,</span> <span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">-%y&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">datetime_formats</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">continue</span></div>

<div class="viewcode-block" id="BarTender.date_range_parser"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.date_range_parser">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">date_range_parser</span><span class="p">(</span><span class="n">date_range_string</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Utility function for converting the date ranges in the cocktail.units</span>
<span class="sd">            metadata csv file to datetime objects using the `datetime_converter`</span>
<span class="sd">            classmethod.</span>

<span class="sd">            Date ranges should have the format</span>

<span class="sd">            start date - end date</span>

<span class="sd">            If the date range is for the most recent cocktail menu then there</span>
<span class="sd">            will not be an end date and the format will be</span>

<span class="sd">            start date - </span>

<span class="sd">        :param date_range_string: string to pull dates out of   </span>
<span class="sd">        :type date_range_string: str</span>
<span class="sd">        :return: tuple of datetime objects, start date and end date</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">date_range_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">BarTender</span><span class="o">.</span><span class="n">datetime_converter</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">BarTender</span><span class="o">.</span><span class="n">datetime_converter</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span></div>

<div class="viewcode-block" id="BarTender.add_menus_from_metadata"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.add_menus_from_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_menus_from_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds menu objects to the menus attribute.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_meta</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cocktail_meta</span><span class="p">))</span> <span class="k">as</span> <span class="n">menu_files</span><span class="p">:</span>
                <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">menu_files</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">COCKTAIL_DATA_PATH</span><span class="p">),</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;File Name&#39;</span><span class="p">])</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">BarTender</span><span class="o">.</span><span class="n">date_range_parser</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;Dates Used&#39;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">=</span> <span class="n">Menu</span><span class="p">(</span>
                        <span class="n">path</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Screen Type&#39;</span><span class="p">]</span>
                    <span class="p">)</span></div>
                    <span class="c1"># add new menu to menus dict path to csv file is the menu</span>
                    <span class="c1"># key</span>

<div class="viewcode-block" id="BarTender.get_menu_by_date"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.get_menu_by_date">[docs]</a>    <span class="k">def</span> <span class="nf">get_menu_by_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get a menu instance who&#39;s usage dates include the given date and</span>
<span class="sd">        match the given screen type.</span>

<span class="sd">        Screen types can either be &#39;s&#39; for &#39;soluble&#39; screens or &#39;m&#39; for</span>
<span class="sd">        membrane screens.</span>

<span class="sd">        :param date: Date to search menus with</span>
<span class="sd">        :type date: datetime</span>
<span class="sd">        :param type_: Type of screen to return (soluble or membrane)</span>
<span class="sd">        :type type_: str</span>
<span class="sd">        :return: menu matching the given date and type</span>
<span class="sd">        :rtype: Menu</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="c1"># search for a menu whos usage dates include this date</span>
            <span class="n">menus_keys_by_date</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">type_</span> <span class="o">==</span> <span class="n">type_</span><span class="p">],</span>
                <span class="c1"># keys matching only the specified type</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">start_date</span>
            <span class="p">)</span>
            <span class="c1"># end up with a list of keys for menus of the specified type that</span>
            <span class="c1"># are sorted by the start date of their use at HWI cente</span>
            <span class="k">for</span> <span class="n">each_key</span> <span class="ow">in</span> <span class="n">menus_keys_by_date</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">each_key</span><span class="p">]</span><span class="o">.</span><span class="n">start_date</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">each_key</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">menus_keys_by_date</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span></div>

<div class="viewcode-block" id="BarTender.get_menus_by_type"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.get_menus_by_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_menus_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns all menus of a given screen type.</span>

<span class="sd">        &#39;s&#39; for soluble screens and &#39;m&#39; for membrane screens. No other</span>
<span class="sd">        characters should be passed to `type_`.</span>

<span class="sd">        :param type_: Key for type of screen to return</span>
<span class="sd">        :type type_: str (max length 1)</span>
<span class="sd">        :return: list of menus of that screen type</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">menu</span> <span class="k">for</span> <span class="n">menu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">menu</span><span class="o">.</span><span class="n">type_</span> <span class="o">==</span> <span class="n">type_</span><span class="p">]</span></div>

<div class="viewcode-block" id="BarTender.get_menu_by_path"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.BarTender.get_menu_by_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_menu_by_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a menu by its file path, which is used as the key</span>
<span class="sd">        for accessing the menus attribute normally.</span>

<span class="sd">        :param path: file path of a menu csv file</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :return: Menu instance that is mapped to given path</span>
<span class="sd">        :rtype: Menu</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menus</span><span class="p">[</span><span class="n">path</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="CocktailMenuReader"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.CocktailMenuReader">[docs]</a><span class="k">class</span> <span class="nc">CocktailMenuReader</span><span class="p">():</span>

    <span class="n">cocktail_map</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># map Cocktail attributes to index in menu rows</span>
        <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;well_assignment&#39;</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span>
        <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;pH&#39;</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;commercial_code&#39;</span>
    <span class="p">}</span>
    <span class="n">formula_pos</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># each reagent could have a formula but only ever</span>
    <span class="c1"># one is included per cocktail entry</span>
    <span class="c1"># all other indicies are reagent names and concentrations</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">menu_file</span><span class="p">,</span> <span class="n">delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a CocktailMenuReader instance, which is basically a</span>
<span class="sd">        csv.reader instance with extra steps. The iterator returns Cocktail</span>
<span class="sd">        instances instead or lists so when creating Menus, the csv file that</span>
<span class="sd">        holds the cocktail data can be read directly ad Cocktail instances</span>
<span class="sd">        instead of dealing with converting the rows to Cocktails when creating</span>
<span class="sd">        Menus.</span>

<span class="sd">        :param menu_file: Path to cocktail menu file to read. Should be csv</span>
<span class="sd">                          formated</span>
<span class="sd">        :type menu_file: str or Path </span>
<span class="sd">        :param delim: Seperator for menu_file; really should not need to </span>
<span class="sd">                      be changed, defaults to &#39;,&#39;</span>
<span class="sd">        :type delim: str, optional</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menu_file</span> <span class="o">=</span> <span class="n">menu_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">menu_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delim</span> <span class="o">=</span> <span class="n">delim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__row_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="CocktailMenuReader.set_cocktail_map"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.CocktailMenuReader.set_cocktail_map">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_cocktail_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">map</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Classmethod to edit the cocktail_map. The cocktail map describes</span>
<span class="sd">        where Cocktail level information is stored in a given cocktail menu</span>
<span class="sd">        file row. It is a dictionary that maps specific indicies in a row to</span>
<span class="sd">        the Cocktail attribute to set the value of the key index to.</span>

<span class="sd">        The default cocktail_map dictionary is below.</span>

<span class="sd">        cocktail_map = {</span>
<span class="sd">        0: &#39;well_assignment&#39;,</span>
<span class="sd">        1: &#39;number&#39;,</span>
<span class="sd">        8: &#39;pH&#39;,</span>
<span class="sd">        2: &#39;commercial_code&#39;</span>
<span class="sd">        }</span>

<span class="sd">        This tells instances of CocktailMenuReader to look at index 0 of a row</span>
<span class="sd">        for the well_assignment attribute of the Cocktail class, index 1 for</span>
<span class="sd">        the number attribute of the Cocktail class, etc.</span>

<span class="sd">        :param map: Dictionary mapping csv row indicies to Cocktail object</span>
<span class="sd">                    attributes</span>
<span class="sd">        :type map: dict</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">cocktail_map</span> <span class="o">=</span> <span class="n">cocktail_map</span></div>

<div class="viewcode-block" id="CocktailMenuReader.set_formula_pos"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.CocktailMenuReader.set_formula_pos">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_formula_pos</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Classmethod to change the formula_pos attribute. The formula_pos</span>
<span class="sd">        describes the location (base 0) of the chemical formula in a row of</span>
<span class="sd">        a cocktail menu file csv. For some reason, HWI cocktail menu files</span>
<span class="sd">        will only have one chemical formula per row (cocktail) no matter</span>
<span class="sd">        the number of reagents that composite that cocktail. This is why</span>
<span class="sd">        its location is represented using an int instead of a dict.</span>

<span class="sd">        Generally, formula_pos should not be changed without a very good</span>
<span class="sd">        reason as the position of the chemical formula is consistent across</span>
<span class="sd">        all HWI cocktail menu files.</span>

<span class="sd">        :param pos: Index where chemical formula can be found</span>
<span class="sd">        :type pos: int</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">formula_pos</span> <span class="o">=</span> <span class="n">pos</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">menu_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the instances menu file</span>

<span class="sd">        :return: the menu file path</span>
<span class="sd">        :rtype: str or Path or IO</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__menu_file</span>

    <span class="nd">@menu_file</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">menu_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_file</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Setter method for the menu_file attribute. If the value passed in</span>
<span class="sd">        is a string will open the file, iterate over the first two lines as</span>
<span class="sd">        these are header lines in all the HWI cocktail menu files included with</span>
<span class="sd">        Polo and set menu_file to the IO stream.</span>

<span class="sd">        :param new_file: [description]</span>
<span class="sd">        :type new_file: [type]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__menu_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
            <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__menu_file</span><span class="p">)</span>
            <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__menu_file</span><span class="p">)</span>  <span class="c1"># skip first two rows</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__menu_file</span> <span class="o">=</span> <span class="n">new_file</span>

    <span class="c1"># need to deciede how fixed on the current header system want to be</span>
    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># would be nice if returned a cocktail</span>
        <span class="sd">&#39;&#39;&#39;Dictates the behavior of CocktailMenuReader objects when `next`</span>
<span class="sd">        is called. Uses the csv.reader object stored in the reader attribute</span>
<span class="sd">        to get the next row of the csv file in a consistent way and then</span>
<span class="sd">        converts the information in that row to a Cocktail object.</span>

<span class="sd">        :return: Cocktail instance representing the cocktail at the next row of</span>
<span class="sd">                 the menu_file</span>
<span class="sd">        :rtype: Cocktail</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cocktail_map</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
             <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_map</span><span class="p">}</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Cocktail</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span>
        <span class="n">reagent_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cocktail_map</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">formula_pos</span><span class="p">]</span>
        <span class="c1"># positions that should contain reagent information. Additionally,</span>
        <span class="c1"># reagent names and their concentrations should now be adjacent to</span>
        <span class="c1"># each other in the list of indicies</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">reagent_pos</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">chem_add</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">reagent_pos</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">row</span><span class="p">[</span><span class="n">reagent_pos</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">chem_add</span><span class="p">:</span>
                <span class="n">con</span> <span class="o">=</span> <span class="n">SignedValue</span><span class="o">.</span><span class="n">make_from_string</span><span class="p">(</span><span class="n">con</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">add_reagent</span><span class="p">(</span>
                    <span class="n">Reagent</span><span class="p">(</span>
                        <span class="n">chemical_additive</span><span class="o">=</span><span class="n">chem_add</span><span class="p">,</span>
                        <span class="n">concentration</span><span class="o">=</span><span class="n">con</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">formula_pos</span><span class="p">]:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">reagents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">chemical_formula</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">formula_pos</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">break</span></div>


<div class="viewcode-block" id="Menu"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.Menu">[docs]</a><span class="k">class</span> <span class="nc">Menu</span><span class="p">():</span>  <span class="c1"># holds the dictionary of cocktails</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creates a Menu instance. Menu objects are used to organize a single</span>
<span class="sd">        screening run plate set up. They should contain 1536 unique screening</span>
<span class="sd">        conditions; one for each well in the HWI highthrouput plate. HWI</span>
<span class="sd">        has altered what cocktails are used in each of the 1536 wells over the</span>
<span class="sd">        years and so many versions of cocktail menus have been used. A single</span>
<span class="sd">        Menu instance represents one of these versions and accordingly has a</span>
<span class="sd">        start and end date to identify when the menu was used. Additionally, </span>
<span class="sd">        HWI offers two types of high throughput screens; membrane or solulbe</span>
<span class="sd">        screens. Both use 1536 well plates but have very different chemical</span>
<span class="sd">        conditions at the same well index. </span>

<span class="sd">        Menus that hold conditions for soluble screens are the `type_`</span>
<span class="sd">        attribute set to &#39;s&#39; and menus that hold conditions for membrane</span>
<span class="sd">        screens have the `type_` attribute set to &#39;m&#39;.</span>

<span class="sd">        :param path: Location of the menu csv file</span>
<span class="sd">        :type path: str</span>
<span class="sd">        :param start_date: Date when this screen menu was first used</span>
<span class="sd">        :type start_date: datetime</span>
<span class="sd">        :param end_date: Last date this screen menu was used</span>
<span class="sd">        :type end_date: datetime</span>
<span class="sd">        :param type_: Membrane or soluble screen</span>
<span class="sd">        :type type_: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type_</span> <span class="o">=</span> <span class="n">type_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__cocktails</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># holds all cocktails (items on the menu)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cocktails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Property to return the Menu instance&#39;s cocktail dict</span>

<span class="sd">        :return: cocktail attribute</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cocktails</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Property to return the Menu instance&#39;s path attribute</span>

<span class="sd">        :return: The path attribute</span>
<span class="sd">        :rtype: str or IO</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__path</span>

    <span class="nd">@path</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Setter function for path attribute. Creates an instance of</span>
<span class="sd">        a CocktailMenuReader class and passes the path attribute to it.</span>
<span class="sd">        Then uses the CocktailMenuReader instance to read the contents of</span>
<span class="sd">        the new_path (which should be a csv file) as Cocktail objects.</span>
<span class="sd">        Cocktail instances are added to the __cocktail dict by their</span>
<span class="sd">        well number assignemnt.</span>

<span class="sd">        :param new_path: [description]</span>
<span class="sd">        :type new_path: [type]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__path</span> <span class="o">=</span> <span class="n">new_path</span>  <span class="c1"># set the path to the new_path</span>
        <span class="n">cocktail_reader</span> <span class="o">=</span> <span class="n">CocktailMenuReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cocktail</span> <span class="ow">in</span> <span class="n">cocktail_reader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cocktails</span><span class="p">[</span><span class="n">cocktail</span><span class="o">.</span><span class="n">well_assignment</span><span class="p">]</span> <span class="o">=</span> <span class="n">cocktail</span></div>
        <span class="c1"># create dictionary from cocktails, key is the well number (assignment)</span>


<span class="c1"># orphan functions that have not made it into a class yet</span>
<span class="c1"># =============================================================================</span>


<div class="viewcode-block" id="write_screen_html"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.write_screen_html">[docs]</a><span class="k">def</span> <span class="nf">write_screen_html</span><span class="p">(</span><span class="n">plate_list</span><span class="p">,</span> <span class="n">well_number</span><span class="p">,</span> <span class="n">run_name</span><span class="p">,</span> <span class="n">x_reagent</span><span class="p">,</span>
                      <span class="n">y_reagent</span><span class="p">,</span> <span class="n">well_volume</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>

    <span class="n">template</span> <span class="o">=</span> <span class="n">SCREEN_HTML_TEMPLATE</span>
    <span class="n">template_string</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">SCREEN_HTML_TEMPLATE</span><span class="p">))</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">template_string</span><span class="p">)</span>

    <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">plate_list</span><span class="o">=</span><span class="n">plate_list</span><span class="p">,</span> <span class="n">run_name</span><span class="o">=</span><span class="n">run_name</span><span class="p">,</span>
                           <span class="n">well_number</span><span class="o">=</span><span class="n">well_number</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                           <span class="n">x_reagent_stock</span><span class="o">=</span><span class="n">x_reagent</span><span class="p">,</span>
                           <span class="n">y_reagent_stock</span><span class="o">=</span><span class="n">y_reagent</span><span class="p">,</span>
                           <span class="n">well_volume</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">well_volume</span><span class="p">))</span>

    <span class="n">output_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s1">&#39;.html&#39;</span><span class="p">:</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.html&#39;</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">screen_html</span><span class="p">:</span>
        <span class="n">screen_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_dict_from_run_via_json"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.make_dict_from_run_via_json">[docs]</a><span class="k">def</span> <span class="nf">make_dict_from_run_via_json</span><span class="p">(</span><span class="n">run</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">encoder</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_cocktail_number_as_int"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.get_cocktail_number_as_int">[docs]</a><span class="k">def</span> <span class="nf">get_cocktail_number_as_int</span><span class="p">(</span><span class="n">cocktail_number_string</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">cocktail_number_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_C&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="parse_HWI_filename_meta"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.parse_HWI_filename_meta">[docs]</a><span class="k">def</span> <span class="nf">parse_HWI_filename_meta</span><span class="p">(</span><span class="n">HWI_image_file</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    HWI images have a standard file nameing schema that gives info about when</span>
<span class="sd">    they are taken and well number and that kind of thing. This function returns</span>
<span class="sd">    that data</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">HWI_image_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">HWI_image_file</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">HWI_image_file</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">HWI_image_file</span><span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)),</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">HWI_image_file</span><span class="p">[</span><span class="mi">14</span><span class="p">:</span><span class="mi">22</span><span class="p">],</span> <span class="s1">&#39;%Y&#39;&#39;%m&#39;&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span>
        <span class="n">HWI_image_file</span><span class="p">[</span><span class="mi">22</span><span class="p">:]</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="export_run_to_csv"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.export_run_to_csv">[docs]</a><span class="k">def</span> <span class="nf">export_run_to_csv</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">output_path</span><span class="p">):</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">output_path</span><span class="p">)</span>
    <span class="n">csv_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">run</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="get_available_cocktails"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.get_available_cocktails">[docs]</a><span class="k">def</span> <span class="nf">get_available_cocktails</span><span class="p">():</span>  <span class="c1"># change this to parse metadata</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns a list of cocktail csv files that are included with the Polo</span>
<span class="sd">    program. List is sorted from most recently used cocktails to least </span>
<span class="sd">    recently used. The year the cocktails were first used are the first two</span>
<span class="sd">    characters of the csv file name if downloaded from HWI website.</span>

<span class="sd">    TODO: Inculde metadata file on available cocktails that gives when they</span>
<span class="sd">    were used at the screening center. Add another function to read in that</span>
<span class="sd">    metadata and create dialog so user can select cocktail that would go with</span>
<span class="sd">    their screen.</span>

<span class="sd">    NOTE: Cocktail TSV file had unicode error in it when read using UTF-8</span>
<span class="sd">    incoding but one on webiste did not. Need to ask Bowman about that one.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cocktail_paths</span> <span class="o">=</span> <span class="n">list_dir_abs</span><span class="p">(</span><span class="n">COCKTAIL_DATA_PATH</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">parse_cocktail_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">)</span> <span class="k">for</span> <span class="n">csv_path</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cocktail_paths</span><span class="p">,</span>
                                                                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))]</span></div>
    <span class="c1"># returns list of dictionaries</span>


<div class="viewcode-block" id="list_dir_abs"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.list_dir_abs">[docs]</a><span class="k">def</span> <span class="nf">list_dir_abs</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">files</span><span class="p">,</span> <span class="n">allowed_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">),</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">abs_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">ALLOWED_IMAGE_TYPES</span><span class="p">:</span>
                <span class="n">allowed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">abs_file_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allowed_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">abs_file_path</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">allowed_files</span></div>


<div class="viewcode-block" id="parse_reagents"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.parse_reagents">[docs]</a><span class="k">def</span> <span class="nf">parse_reagents</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">reagents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">:]]</span>
    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">row</span> <span class="k">if</span> <span class="n">i</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">con</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>  <span class="c1"># some solutions without units all have additive name</span>
                <span class="n">reagents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Reagent</span><span class="p">())</span>
                <span class="n">reagents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">chemical_additive</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">con</span> <span class="o">=</span> <span class="n">num_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">con</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">units</span> <span class="o">=</span> <span class="n">unit_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">units</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">reagents</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="n">SignedValue</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">formula</span><span class="p">:</span>
            <span class="n">reagents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">chemical_formula</span> <span class="o">=</span> <span class="n">formula</span>

    <span class="k">return</span> <span class="n">reagents</span></div>


<div class="viewcode-block" id="parse_cocktail_csv"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.parse_cocktail_csv">[docs]</a><span class="k">def</span> <span class="nf">parse_cocktail_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="n">cocktail_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cocktails</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">cocktails</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">well_pos</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">commercial_code</span> <span class="o">=</span> <span class="n">row</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">well_pos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">well_pos</span><span class="p">)))</span>
                    <span class="n">pH</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">cocktail_dict</span><span class="p">[</span><span class="n">well_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cocktail</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span>
                                                       <span class="n">well_assignment</span><span class="o">=</span><span class="n">well_pos</span><span class="p">,</span>
                                                       <span class="n">commercial_code</span><span class="o">=</span><span class="n">commercial_code</span><span class="p">,</span>
                                                       <span class="n">pH</span><span class="o">=</span><span class="n">pH</span><span class="p">)</span>
                    <span class="n">cocktail_dict</span><span class="p">[</span><span class="n">well_pos</span><span class="p">]</span><span class="o">.</span><span class="n">reagents</span> <span class="o">=</span> <span class="n">parse_reagents</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1"> attempting to read </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">e</span><span class="p">,</span> <span class="n">parse_cocktail_csv</span><span class="p">,</span> <span class="n">file_path</span>
                    <span class="p">))</span>
                    <span class="k">continue</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Successfully parsed cocktail file at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cocktail_dict</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1"> attempting to open </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">parse_cocktail_csv</span><span class="p">,</span> <span class="n">file_path</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">e</span></div>


<span class="c1"># attempts to convert date string using bunch of formats</span>
<div class="viewcode-block" id="datetime_converter"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.datetime_converter">[docs]</a><span class="k">def</span> <span class="nf">datetime_converter</span><span class="p">(</span><span class="n">date_string</span><span class="p">):</span>
    <span class="n">date_string</span> <span class="o">=</span> <span class="n">date_string</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">datetime_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%Y&#39;</span><span class="p">,</span> <span class="s1">&#39;%m/</span><span class="si">%d</span><span class="s1">/%y&#39;</span><span class="p">,</span> <span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">-%Y&#39;</span><span class="p">,</span> <span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">-%y&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">form</span> <span class="ow">in</span> <span class="n">datetime_formats</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">continue</span></div>


<div class="viewcode-block" id="parse_hwi_dir_metadata"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.parse_hwi_dir_metadata">[docs]</a><span class="k">def</span> <span class="nf">parse_hwi_dir_metadata</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
        <span class="n">image_type</span> <span class="o">=</span> <span class="n">dir_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plate_id</span> <span class="o">=</span> <span class="n">dir_name</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dir_name</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="s1">&#39;%Y&#39;&#39;%m&#39;&#39;</span><span class="si">%d</span><span class="s1">&#39;&#39;%H&#39;&#39;%M&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image_type</span><span class="p">,</span> <span class="n">plate_id</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">dir_name</span>  <span class="c1"># last is suggeseted run name</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1"> attempting to parse </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">parse_hwi_dir_metadata</span><span class="p">,</span> <span class="n">dir_name</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">e</span></div>


<div class="viewcode-block" id="parse_cocktail_metadata"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.parse_cocktail_metadata">[docs]</a><span class="k">def</span> <span class="nf">parse_cocktail_metadata</span><span class="p">():</span>
    <span class="c1"># parse the metadata csv file into a dictionary of cocktail csv files</span>
    <span class="n">cocktail_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dates_header</span> <span class="o">=</span> <span class="s1">&#39;Dates Used&#39;</span>
    <span class="n">path_header</span> <span class="o">=</span> <span class="s1">&#39;File Name&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">COCKTAIL_META_DATA</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">COCKTAIL_META_DATA</span><span class="p">))</span> <span class="k">as</span> <span class="n">meta_cock</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">meta_cock</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">dates</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">dates_header</span><span class="p">]</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">start</span><span class="p">:</span>  <span class="c1"># convert dates to datetime</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">datetime_converter</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">end</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">end</span> <span class="o">=</span> <span class="n">datetime_converter</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">e</span><span class="p">,</span> <span class="n">parse_cocktail_metadata</span><span class="p">))</span>
                <span class="n">row</span><span class="p">[</span><span class="n">dates_header</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">path_header</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cocktail_dict</span><span class="p">[</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>

        <span class="k">return</span> <span class="n">cocktail_dict</span>

    <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Caught </span><span class="si">{}</span><span class="s1"> at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">parse_cocktail_metadata</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">e</span></div>


<div class="viewcode-block" id="read_import_descriptors"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.read_import_descriptors">[docs]</a><span class="k">def</span> <span class="nf">read_import_descriptors</span><span class="p">():</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="directory_validator"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.directory_validator">[docs]</a><span class="k">def</span> <span class="nf">directory_validator</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">list_dir_abs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">ForbiddenImageTypeError</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory validation failed with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="ne">NotADirectoryError</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory validation failed with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="ne">FileNotFoundError</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Directory validation failed with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="ne">FileNotFoundError</span></div>


<div class="viewcode-block" id="check_for_missing_images"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.check_for_missing_images">[docs]</a><span class="k">def</span> <span class="nf">check_for_missing_images</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">expected_image_count</span><span class="p">):</span>
    <span class="n">number_images</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_dir_abs</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">number_images</span> <span class="o">!=</span> <span class="n">expected_image_count</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="run_name_validator"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.run_name_validator">[docs]</a><span class="k">def</span> <span class="nf">run_name_validator</span><span class="p">(</span><span class="n">new_run_name</span><span class="p">,</span> <span class="n">current_run_names</span><span class="p">):</span>
    <span class="c1"># checks that new run name is utf 8 and</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">new_run_name</span> <span class="o">=</span> <span class="n">new_run_name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">new_run_name</span> <span class="o">=</span> <span class="n">new_run_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> failed run name validation with </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">new_run_name</span><span class="p">,</span> <span class="n">e</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">new_run_name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">new_run_name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="ne">TypeError</span>
    <span class="k">if</span> <span class="n">new_run_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_run_names</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="if_dir_not_exists_make"><a class="viewcode-back" href="../../../polo.utils.html#polo.utils.io_utils.if_dir_not_exists_make">[docs]</a><span class="k">def</span> <span class="nf">if_dir_not_exists_make</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">child_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    If only parent_dir is given attempts to make that directory. If parent</span>
<span class="sd">    and child are given tries to make a directory child_dir within parent dir.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">child_dir</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="n">child_dir</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">parent_dir</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not make directory with path </span><span class="si">{}</span><span class="s1">. Returned </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">e</span>
            <span class="p">))</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="k">return</span> <span class="n">path</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Ethan T. Holleman

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>